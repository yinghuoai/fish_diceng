//ICC-AVR application builder : 2006-11-23 22:56:28
// Target : M128
// Crystal: 8.0000Mhz
/*  
   comunicating protocol with the radio controller:
   ·¢ËÍ8Î»¶ş½øÖÆÊı
   1±íÊ¾½ÓÉÏ
   0±íÊ¾ËÉ¿ª
   eg:   1111   X  X  X  X
                Ç° ºó ×ó ÓÒ
*/  

/*
*
*  ÊÖ¶¯Ä£Ê½ºÍ×Ô¶¯Ä£Ê½µÄÇĞ»»£ºunsigned char is_uart=0;//ÈôÊÇÏëÆÁ±Îµô¿ªµçÔËĞĞµÄ×Ô¶¯Ä£Ê½£¬ÖÃ´Ë±êÖ¾Î»Îª1
*
*
*
*/
#include <iom128v.h>
#include <macros.h>
#include "TWI_Master.h"

#define FLK 8 	   	  	 //¾§Õñ crystal
#define PI 3.1416        //**Ô²ÖÜÂÊ
#define Joint_Num  3

#define SLA_W 0xA0
#define SLA_R 0xA1

////////////////////////////----i2cµØÖ·--BEGIN----///////////////////////
//ÓĞĞ©i2cÒ»´Î¿ÉÒÔĞ´16¸ö£¬¶øÓĞĞ©Ò»´ÎÖ»ÄÜĞ´8¸ö£¬ÎªÁËÍ¨ÓÃĞÔ£¬´Ë´¦Ã¿´ÎĞ´Èë8¸ö
//¶Á²»ÊÜÏŞÖÆ
#define ADD_i 0x10//ID*1
#define ADD_f 0x20//ÆµÂÊ*1
#define ADD_t 0x30//µ÷Ö±*3
#define ADD_s1 0x40//ËÙ¶È*16
#define ADD_s2 0x48
#define ADD_d 0x50//ÖÍºó½Ç*3
#define ADD_1 0x60//·ù¶È*48
#define ADD_2 0x68
#define ADD_3 0x70
#define ADD_4 0x78
#define ADD_5 0x80
#define ADD_6 0x88
#define ADD_10 0x90//×ª½ÇÆ«ÒÆ*24
#define ADD_20 0x98
#define ADD_30 0xa0
////////////////////////////----i2cµØÖ·--END----///////////////////////
#define PWM_Period_ms 20	     //ms
#define PWM_Duty_Middle_us 1500  //us
#define PWM_Duty_LeftLimit_us 900  //us
#define PWM_Duty_RightLimit_us 2100  //us

#define D_MAX 60  //Dynamic_Offset_degree_origin[0]µÄ×î´óÖµ
#define D_Y_MAX 60  //Dynamic_Offset_degree_y[0]µÄ×î´óÖµ

#define A_MAX 20 //*0.85=Amplitude_degree_tem[0]µÄ×î´óÖµ

#define m_time 0x10 //Ä£Ì¬±ä»¯ÖĞ¿ØÖÆÊ±¼ä
#define y_time 0x2 //Ô­Ê¼×ªÍäÄ£Ê½ÖĞ¿ØÖÆÊ±¼ä//Ã¿Ãë´ó¸Å¼Ó2


int LeftLimit_value, RightLimit_value, MiddlePosition_value,PWM_Period_value;
unsigned char Speed=0;   
unsigned char Instant=0;
unsigned char redata;//´®¿ÚÊı¾İ
unsigned char redata_fan=0;//ÊÇËÙ¶È»ò·½ÏòÖ¸ÁîÊ±£¬´æ´¢¸ÃÖ¸Áî
unsigned char id_fan=0;//ÓÉFISHID[0]ºÍredata_fan×é³ÉµÄ1¸ö×Ö½ÚÊı£¬·µ»ØÖµ
unsigned char redata_tem;//ÃüÁîÊı¾İÔİ´æ
unsigned char redata_i2c;//i2cÃüÁîÊı¾İÔİ´æ
unsigned char baocun_i=0;
unsigned char t_dynamic=0;//×ªÍäÃüÁîºó£¬´ÓÔ­×´Ì¬µ½ĞÂ×´Ì¬µÄ¹ı¶ÉÊ±¼ä£¬ÊÕµ½ÃüÁîºóµÄ0µ½Speed_dynamic/2Ê±¼ä¶ÎÎª¹ı¶É×´Ì¬
unsigned char Speed_dynamic=0;//ÊÕµ½×ªÍäÃüÁîÊ±¿ÌµÄSpeedÖµ

unsigned char n=0;
unsigned char m=0;//²âÊÔÊ±Ñ­»··¢Êı¾İÓÃ
unsigned char s=0;//²ğ·ÖÊı×é×Óº¯ÊıÖĞÊ¹ÓÃ

//////////////----ĞèÒªĞ´Èëi2cµÄÊı¾İ--BEGIN----//////////////////
unsigned char FISHID[1]={0x01};//µØÖ·ADD_i
unsigned char FISHID_init[1]={0x01};
unsigned char FISHID_I2C[3]={0,0,0x01};

unsigned char freqs[1]={0};//µØÖ·ADD_f,freq[freqs[x]]
unsigned char freqs_init[1]={0};
unsigned char freqs_I2C[3]={0,0,0};

unsigned char Static_Offset_degree[3]={0,0,0};//µØÖ·ADD_t
unsigned char Static_Offset_degree_init[3]={0,0,0};
unsigned char degree_I2C[5]={0,0,0,0,0};

//Speed_tem[16]//µØÖ·ADD_s1,s2
unsigned char Speed_tem_init[16]={0,255,240,225,210,195,180,165,150,135,120,105,90,75,60,45};
unsigned char Speed_tem_I2C[18]={0};  

unsigned char Speed_tem_init1[8]={0};
unsigned char Speed_tem_init2[8]={0};

unsigned char Speed_tem_z[16]={0};//Dynamic_Offset_degree_origin[8][3]Ö±½Ó×ª³ÉµÄ1Î¬Êı×é
unsigned char Speed_tem_z1[8]={0};//0-7
unsigned char Speed_tem_z2[8]={0};//8-16

unsigned char Speed_tem_I2C1[10]={0};
unsigned char Speed_tem_I2C2[10]={0};

//Neighbouring_Offset_degree[3]//µØÖ·ADD_d
unsigned char Neighbouring_Offset_degree_init[3]={0,80,120};
unsigned char Neighbouring_Offset_degree_I2C[5]={0};


//Amplitude_degree_tem[16][3]//µØÖ·ADD_1,2,3,4,5,6
unsigned char Amplitude_degree_tem_init[48]=
              {
			    0.1*A_MAX,0.1*A_MAX+10,0.1*A_MAX+15,//0 £¬ËÙ¶ÈĞ¡°Ú·ùĞ¡
                0.15*A_MAX,0.15*A_MAX+10,0.15*A_MAX+15,//1
                0.2*A_MAX,0.2*A_MAX+10,0.2*A_MAX+15,//
                0.25*A_MAX,0.25*A_MAX+10,0.25*A_MAX+15,//3
                0.3*A_MAX,0.3*A_MAX+10,0.3*A_MAX+15,//
                0.35*A_MAX,0.35*A_MAX+10,0.35*A_MAX+15,//5
                0.4*A_MAX,0.4*A_MAX+10,0.4*A_MAX+15,//
                0.45*A_MAX,0.45*A_MAX+10,0.45*A_MAX+15,//7
                0.5*A_MAX,0.5*A_MAX+10,0.5*A_MAX+15,//8******
                0.55*A_MAX,0.55*A_MAX+10,0.55*A_MAX+15,//9
                0.6*A_MAX,0.6*A_MAX+10,0.6*A_MAX+15,//
                0.65*A_MAX,0.65*A_MAX+10,0.65*A_MAX+15,//11
                0.7*A_MAX,0.7*A_MAX+10,0.7*A_MAX+15,//
                0.75*A_MAX,0.75*A_MAX+10,0.75*A_MAX+15,//13
                0.8*A_MAX,0.8*A_MAX+10,0.8*A_MAX+15,//
                0.85*A_MAX,0.85*A_MAX+10,0.85*A_MAX+15//15£¬ËÙ¶È´ó°Ú·ù´ó
			  };
			  //unsigned char Amplitude_degree_tem_I2C[50]={0};
unsigned char Amplitude_degree_tem_init1[8]={0};
unsigned char Amplitude_degree_tem_init2[8]={0};
unsigned char Amplitude_degree_tem_init3[8]={0};
unsigned char Amplitude_degree_tem_init4[8]={0};
unsigned char Amplitude_degree_tem_init5[8]={0};
unsigned char Amplitude_degree_tem_init6[8]={0};
unsigned char Amplitude_degree_tem_z[48]={0};//Amplitude_degree_tem[16][3]Ö±½Ó×ª³ÉµÄ1Î¬Êı×é
unsigned char Amplitude_degree_tem_z1[8]={0};//0-11
unsigned char Amplitude_degree_tem_z2[8]={0};//12-23
unsigned char Amplitude_degree_tem_z3[8]={0};//24-35
unsigned char Amplitude_degree_tem_z4[8]={0};//36-47
unsigned char Amplitude_degree_tem_z5[8]={0};//36-47
unsigned char Amplitude_degree_tem_z6[8]={0};//36-47
unsigned char Amplitude_degree_tem_I2C1[10]={0};
unsigned char Amplitude_degree_tem_I2C2[10]={0};
unsigned char Amplitude_degree_tem_I2C3[10]={0};
unsigned char Amplitude_degree_tem_I2C4[10]={0};
unsigned char Amplitude_degree_tem_I2C5[10]={0};
unsigned char Amplitude_degree_tem_I2C6[10]={0};

//Dynamic_Offset_degree_origin [8][3],µØÖ·ADD_10,20,30,40
unsigned char Dynamic_Offset_degree_origin_init[24]=
{
  D_MAX,D_MAX-5,0,  //ÓÒ14£¬ÓÒ15£¬×ó0£¬¼±//¼Ó¸ººÅÊÇ×ó
  0.8*D_MAX,0.8*D_MAX-5,0, //ÓÒ13£¬×ó1£¬q
  0.6*D_MAX,0.6*D_MAX-5,0,  //ÓÒ12£¬×ó2,w
  0.45*D_MAX,0.45*D_MAX-5,0, //ÓÒ11£¬×ó3,e
  0.3*D_MAX,0.3*D_MAX-5,0,  //ÓÒ10£¬×ó4.r
  0.15*D_MAX,0.15*D_MAX-5,0, //ÓÒ9£¬×ó5.t
  0.1*D_MAX,0.1*D_MAX-5,0,  //ÓÒ8£¬×ó6£¬»º.y
    0,  0,  0 //ÖĞ7£¬²»×ª
};
unsigned char Dynamic_Offset_degree_origin_init1[8]={0};
unsigned char Dynamic_Offset_degree_origin_init2[8]={0};
unsigned char Dynamic_Offset_degree_origin_init3[8]={0};
unsigned char Dynamic_Offset_degree_origin_z[24]={0};//Dynamic_Offset_degree_origin[8][3]Ö±½Ó×ª³ÉµÄ1Î¬Êı×é
unsigned char Dynamic_Offset_degree_origin_z1[8]={0};//0-11
unsigned char Dynamic_Offset_degree_origin_z2[8]={0};//12-23
unsigned char Dynamic_Offset_degree_origin_z3[8]={0};//12-23
unsigned char Dynamic_Offset_degree_origin_I2C1[10]={0};//
unsigned char Dynamic_Offset_degree_origin_I2C2[10]={0};//
unsigned char Dynamic_Offset_degree_origin_I2C3[10]={0};//
//////////////----ĞèÒªĞ´Èëi2cµÄÊı¾İ--END----//////////////////


/////////////----¶¨Òå±êÖ¾Î»--BEGIN----//////////////////
unsigned char isSrlStart=0;//ÊÕµ½¿ªÊ¼Î»Ê±ÖÃ1£»µ±Îª1Ê±£¬¿ªÊ¼½ÓÊÕÏÂÒ»Î»µØÖ·Âë£¬²¢ÅĞ¶ÏÊÇ·ñÆ¥Åä
unsigned char isSrlStartI2c=0;//ÊÕµ½³õÊ¼»¯I2cµÄÆğÊ¼Î»Ê±ÖÃ1£»¿ªÊ¼½ÓÊÕÏÂÒ»Î»µØÖ·Âë£¬²¢ÅĞ¶ÏÊÇ·ñÆ¥Åä
unsigned char addr=0;//µØÖ·Î»Æ¥ÅäÊ±ÖÃ1£»¿ªÊ¼½ÓÊÕÏÂÒ»Î»ÃüÁîÎ»
unsigned char addrI2c=0;//i2cµØÖ·Î»Æ¥ÅäÊ±ÖÃ1£»¿ªÊ¼½ÓÊÜÏÂÒ»Î»i2cÃüÁîÎ»
unsigned char s_change=0;//ËÙ¶È¸Ä±äÊ±ÖÃ1 
unsigned char d_change=0;//·½Ïò¸Ä±äÊ±ÖÃ1
unsigned char d_change_t=0;//·½Ïò¸Ä±ä,¹ı¶É×´Ì¬ÖĞÎª1£¬ÎÈ¶¨ºóÇåÁã
unsigned char d_change_t_v=0;//·½Ïò¸Ä±äÊ±ÖÃ1£¬½«ÊµÊ±Æ«ÒÆ½Ç¸³¸ølast×÷ÎªÇ°Ò»×´Ì¬Æ«ÒÆ½Ç£¬È»ºóÇåÁã¸Ã±êÖ¾Î»
unsigned char t_change=0;//µ÷Ö±Ê±ÖÃ1
unsigned char ts_change=0;//±£´æ»òÈ¡Ïûµ÷Ö±×´Ì¬Ê±ÖÃ1
unsigned char a_change=0;//·ù¶È¸Ä±äÊ±ÖÃ1
unsigned char f_change=0;//ÆµÂÊ¸Ä±äÊ±ÖÃ1
unsigned char id_change=0;//id¸Ä±äÊ±ÖÃ1
unsigned char e_change=0;//½ÓÊÕµ½½áÊøÎ»Ê±ÖÃ1
unsigned char i_change=0;//½ÓÊÕµ½i2c³õÊ¼»¯ÃüÁîÊ±ÖÃÎª1
unsigned char i2c_change=0;//½ÓÊÕµ½i2c³õÊ¼»¯ÃüÁîµÄ½áÊøÎ»Ê±ÖÃÎª1
unsigned char isInstruction=0;//ÊÇ·ñ½ÓÊÕµ½Ö¸Áî£¬ÒÑ½ÓÊÕÖÃÎª1£¬Î´½ÓÊÕ£¬ÖÃÎª0£»ÉèÖÃ¸ö±êÖ¾Î»£¬±£Ö¤Ö¸Áî±ØĞëÊÇËÄÎ»²ÅÄÜ¹»Ö´ĞĞ£¬±ÈÈçaa 9_ d5 d0 fcÕâÑùµÄÖ¸ÁîÊÇÎŞĞ§µÄ£¬µ«ÈôÎŞ´Ë±êÖ¾Î»£¬Õâ¸öÖ¸Áî¾ÍÊÇÓĞĞ§µÄ£¬²¢ÇÒÖ´ĞĞd0ÃüÁî 
unsigned char isInstructionI2c=0;//ÊÇ·ñ½ÓÊÕµ½i2cÖ¸Áî£¬ÒÑ½ÓÊÕÖÃÎª1£¬Î´½ÓÊÕ£¬ÖÃÎª0£»ÉèÖÃ¸ö±êÖ¾Î»£¬±£Ö¤Ö¸Áî±ØĞëÊÇËÄÎ»²ÅÄÜ¹»Ö´ĞĞ£¬±ÈÈçcc 74 8_ aa fcÕâÑùµÄÖ¸ÁîÊÇÎŞĞ§µÄ£¬µ«ÈôÎŞ´Ë±êÖ¾Î»£¬Õâ¸öÖ¸Áî¾ÍÊÇÓĞĞ§µÄ£¬²¢ÇÒÖ´ĞĞ8_ÃüÁî 
//ÒÔÉÏ±êÖ¾Î»£¬½ÓÊÕµ½½áÊøÎ»£¬Ö´ĞĞÃüÁîºó£¬Çå0

unsigned char is_uart=1;//´®¿ÚÊÇ·ñ½ÓÊÕµ½ÃüÁî£¬Óã¸Õ¿ªµçÊ±£¬´Ë±êÖ¾Î»ÈôÎª0£¬×Ô¶¯ÔËĞĞÉè¶¨µÄÄ£Ê½£¬µ±´®¿Ú½ÓÊÜµ½¿ØÖÆÃüÁîÊ±ºò£¬´Ë±êÖ¾Î»ÖÃÎª1£¬½øÈëÊÖ¶¯¿ØÖÆÄ£Ê½
unsigned char m_change=0;//½ÓÊÕµ½Ä£Ì¬ÂëÊ±ÖÃ1£¬½ÓÊÕµ½ÆäËüÃüÁîÊ±Çå0
unsigned char m_cishu=0;//mm_cishu,mmm_cishu¹²Í¬¾ö¶¨Ä£Ì¬ÂëÖÃ1ºóÑ­»·µÄ´ÎÊı
unsigned char mm_cishu=0;//
unsigned char mmm_cishu=m_time-1;//
unsigned char a_cishu=0;//aa_cishu,aaa_cishu¹²Í¬¾ö¶¨×Ô¶¯×´Ì¬Ñ­»·µÄ´ÎÊı//*auto
unsigned char aa_cishu=0;//
unsigned char aaa_cishu=m_time-1;//
unsigned char cishu=0;//Ä£Ì¬ÖĞ¶¯×÷Ñ­»·£¬ÒÔ3ÎªÖÜÆÚ£¬¼´0,1,2,0,1,2....
unsigned char auto_cishu=0;//Ä£Ì¬ÖĞ¶¯×÷Ñ­»·£¬ÒÔ5ÎªÖÜÆÚ£¬¼´0,1,2,3,4,0,1,2,3,4....
unsigned char y_change=0;//½ÓÊÕµ½Ô­Ê¼×ªÍä·½Ê½Ê±ÖÃÎª1£¬½ÓÊÕµ½ÆäËûÃüÁîÊ±Çå0
unsigned char y_changing=0;//ÕıÔÚÖ´ĞĞÔ­Ê¼×ªÍä·½Ê½Ê±ÖÃÎª1£¬´ËÊ±²»½ÓÊÜÆäËûÃüÁî
unsigned char yy_time=0xff;//Óëy_time¹²Í¬¾ö¶¨Ô­Ê¼×ªÍäÄ£Ê½µÄÊ±¼ä
unsigned char y_cishu=0;   //
unsigned char yy_cishu=0;
unsigned char yyy_cishu=y_time-1;
unsigned char cishu_y=0;//0Ê±×ªÍä£¬1Ê±»Øµ½ÊÕµ½ÃüÁîÇ°µÄËÙ¶È£¬Ö±ÓÎ
unsigned char y_tem=0;//×ªÍäµµ
unsigned char y_speed=0;//±£´æ×ªÍäÇ°ËÙ¶È
/////////////----¶¨Òå±êÖ¾Î»--END----//////////////////


/////////////----¸÷µµ²ÎÊı--BEGIN----//////////////////
unsigned char s_tem=0;//ËÙ¶Èµµ£¬Speed_tem[s_tem],Amplitude_degree_tem[s_tem][i]
unsigned char m_tem=0;//m_tem&0x0f=Ä£Ì¬µµ
unsigned char d_tem=0;//·½Ïòµµ£¬Dynamic_Offset_degree_origin [d_tem][i]
unsigned char dd_tem=0;//·½Ïòµµ×óÓÒÍ¬Ò»ºó£¬
unsigned char flag=0;
// d_tem 0  1  2  3  4  5  6  7  8  9  10  11  12  13  14  15 //7Ç°×ó£¬ºóÓÒ
//dd_tem 0  1  2  3  4  5  6  7  6  5  4   3   2   1   0   0 //¼Ó¸ººÅ×ó
////flag=1Ê±£¬×ó×ªd_temĞ¡ÓÚ7£¬¼Ó¸ººÅ£¬flag=0£¬ÓÒ×ªd_tem´óÓÚµÈÓÚ7
//unsigned char y_tem=0;//Ô­Ê¼×ªÍäµµ
unsigned char i2c_canshu=0;//±£´æ²ÎÊıĞŞ¸ÄÊ±ÖÃ1

//4¸öÆµÂÊ£¬¾ÉÍ¨ĞÅÄ£¿éµÄ¸ÄÆµÂÊ£¬ĞÂÍ¨ĞÅÄ£¿é²»ÓÃ´Ë±äÁ¿
unsigned char freq[4]={0xff,0xf7,0xef,0xdf};

//16µµËÙ¶ÈÖµ,0-15,SpeedÖµÔ½´ó£¬ËÙ¶ÈÔ½Ğ¡
unsigned char Speed_tem[16]=  
{
  0,255,240,225,210,195,180,165,150,135,120,105,90,75,60,45//³õÊ¼Öµ£¬8-150
};//×î´ó255//×îÂı150±È½ÏºÏÊÊ

//16µµ×ªÍäÖµ£¬0-15,7²»×ª
unsigned char Dynamic_Offset_degree_origin[8][Joint_Num]=
{
  {D_MAX,D_MAX-5,0},  //ÓÒ14£¬ÓÒ15£¬×ó0£¬¼±//¼Ó¸ººÅÊÇ×ó
  {0.9*D_MAX,0.9*D_MAX-5,0}, //ÓÒ13£¬×ó1£¬q
  {0.8*D_MAX,0.8*D_MAX-5,0},  //ÓÒ12£¬×ó2,w
  {0.7*D_MAX,0.7*D_MAX-5,0}, //ÓÒ11£¬×ó3,e
  {0.5*D_MAX,0.5*D_MAX-5,0},  //ÓÒ10£¬×ó4.r
  {0.3*D_MAX,0.3*D_MAX-5,0}, //ÓÒ9£¬×ó5.t
  {0.1*D_MAX,0.1*D_MAX-5,0},  //ÓÒ8£¬×ó6£¬»º.y
    {0,  0,  0} //ÖĞ7£¬²»×ª
};//³£Á¿Êı×é£¬¸ø³öDynamic_Offset_degreeµÄÖµ

//Ô­Ê¼×ªÍä·½Ê½£¬16µµ×ªÍäÖµ£¬0-15,7²»×ª
int Dynamic_Offset_degree_y[16][Joint_Num] =
{
  {-D_Y_MAX,-D_Y_MAX-5,-D_Y_MAX-10},  //×ó0£¬¼±
  {-0.9*D_Y_MAX,-0.9*D_Y_MAX-5,-0.9*D_Y_MAX-10}, //×ó1
  {-0.8*D_Y_MAX,-0.8*D_Y_MAX-5,-0.8*D_Y_MAX-10},  //×ó2
  {-0.7*D_Y_MAX,-0.7*D_Y_MAX-5,-0.7*D_Y_MAX-10}, //×ó3
  {-0.5*D_Y_MAX,-0.5*D_Y_MAX-5,-0.5*D_Y_MAX-10},  //×ó4
  {-0.3*D_Y_MAX,-0.3*D_Y_MAX-5,-0.3*D_Y_MAX-10}, //×ó5
  {-0.1*D_Y_MAX,-0.1*D_Y_MAX-5,-0.1*D_Y_MAX-10},  //×ó6£¬»º
  {  0,  0,  0}, //ÖĞ7£¬²»×ª
  { 0.1*D_Y_MAX, 0.1*D_Y_MAX-5,0.1*D_Y_MAX-10},  //ÓÒ8£¬»º
  { 0.2*D_Y_MAX, 0.2*D_Y_MAX-5,0.2*D_Y_MAX-10}, //ÓÒ9
  { 0.3*D_Y_MAX, 0.3*D_Y_MAX-5,0.3*D_Y_MAX-10},  //ÓÒ10
  { 0.5*D_Y_MAX, 0.5*D_Y_MAX-5,0.5*D_Y_MAX-10}, //ÓÒ11
  { 0.7*D_Y_MAX, 0.7*D_Y_MAX-5,0.7*D_Y_MAX-10},  //ÓÒ12
  { 0.8*D_Y_MAX, 0.8*D_Y_MAX-5,0.8*D_Y_MAX-10}, //ÓÒ13
  { 0.9*D_Y_MAX, 0.9*D_Y_MAX-5,0.9*D_Y_MAX-10},  //ÓÒ14
  { D_Y_MAX,  D_Y_MAX-5, D_Y_MAX-10} //ÓÒ15£¬¼±
};//³£Á¿Êı×é£¬¸ø³öDynamic_Offset_degreeµÄÖµ

int Joint_Angle_value [Joint_Num] =     //the final value to be written in duty cycle register
{
  0, 0, 0
};//³õÊ¼»¯Öµ

int Static_Offset_value [Joint_Num] =//µ÷Ö±ÓÃ, µ¥Î»Îª¶È
{
  0, 0, 0
};


int Dynamic_Offset_degree [Joint_Num] =// modified through communication×ªÍäÓÃ
{
 0, 0, 0           
};//ÓÃÀ´¼ÆËãDynamic_Offset_value

unsigned char Dynamic_Offset_degree_char[Joint_Num]={0,0,0};

int Dynamic_Offset_value [Joint_Num] =
{
 0, 0, 0
};//¸ù¾İDynamic_Offset_degree¼ÆËãµÃµ½,´æ´¢ÊÕµ½µÄ×ªÍäÃüÁîµÄDynamic_Offset_valueÖµ£¬Ò²¾ÍÊÇÒª´ïµ½µÄÖµ

int Dynamic_Offset_value_per[Joint_Num]=
{
 0,0,0
};//¹ı¶É×´Ì¬Ê±£¬Ã¿´ÎÔö¼ÓµÄÆ«ÒÆ½Ç

int Dynamic_Offset_value_last[Joint_Num]=
{
 0,0,0
};//ÊÕµ½×ªÍäÃüÁîÖ®Ç°µÄDynamic_Offset_valueÖµ

int Dynamic_Offset_value_t[Joint_Num]=
{
 0,0,0
};//ÊµÊ±µÄDynamic_Offset_valueÖµ

unsigned char Neighbouring_Offset_degree[Joint_Num] =// modified through communication Ã¿¹Ø½ÚÏàÎ»²î
{
// 0,60,120
  0,80,120
};
//³£Á¿£¬¾ø¶ÔÏàÎ»²î
unsigned char Amplitude_degree[Joint_Num] =// modified through communication ¸÷¹Ø½Ú°Ú·ù
{
  15,20,25
//   90,20,25
};//³£Á¿,¿ØÖÆ°Ú·ù£¬Asin(),×î´ó90¶È
unsigned char Amplitude_degree_tem[16][Joint_Num] =//16µµ°Ú·ù£¬¶ÔÓ¦ËÙ¶È£¬0-15
{
  {0.1*A_MAX,0.1*A_MAX+10,0.1*A_MAX+15},//0 £¬ËÙ¶ÈĞ¡°Ú·ùĞ¡
  {0.15*A_MAX,0.15*A_MAX+10,0.15*A_MAX+15},//1
  {0.2*A_MAX,0.2*A_MAX+10,0.2*A_MAX+15},//
  {0.25*A_MAX,0.25*A_MAX+10,0.25*A_MAX+15},//3
  {0.3*A_MAX,0.3*A_MAX+10,0.3*A_MAX+15},//
  {0.35*A_MAX,0.35*A_MAX+10,0.35*A_MAX+15},//5
  {0.4*A_MAX,0.4*A_MAX+10,0.4*A_MAX+15},//
  {0.45*A_MAX,0.45*A_MAX+10,0.45*A_MAX+15},//7
  {0.5*A_MAX,0.5*A_MAX+10,0.5*A_MAX+15},//8******
  {0.55*A_MAX,0.55*A_MAX+10,0.55*A_MAX+15},//9
  {0.6*A_MAX,0.6*A_MAX+10,0.6*A_MAX+15},//
  {0.65*A_MAX,0.65*A_MAX+10,0.65*A_MAX+15},//11
  {0.7*A_MAX,0.7*A_MAX+10,0.7*A_MAX+15},//
  {0.75*A_MAX,0.75*A_MAX+10,0.75*A_MAX+15},//13
  {0.8*A_MAX,0.8*A_MAX+10,0.8*A_MAX+15},//
  {0.85*A_MAX,0.85*A_MAX+10,0.85*A_MAX+15}//15£¬ËÙ¶È´ó°Ú·ù´ó
};
/////////////----¸÷µµ²ÎÊı--END----//////////////////


//*************************delayÑÓÊ±º¯Êı**********************
void delay(double interval)
{
	double k;
	for(k=0;k<interval;k++);
}

void delay_1ms(void) 
{ 
 unsigned int i; 
 for (i=0;i<1142;i++) 
  { 
  } 
} 

void delay_nms(unsigned int n) 
{ 
 unsigned int i; 
 for(i=0;i<n;i++) 
 delay_1ms(); 
}


//*************************ÉèÖÃ¸÷¶Ë¿Ú************************
void port_init(void)
{
 PORTA = 0x00;//0000 0001
 DDRA  = 0x00;//0000 0001 PA0¿ÚÊä³ö£¬¸ßµçÆ½
// PORTB = 0xFF;//0xF0;//1111 0000
// DDRB  = 0xFF;//0xF0;//1111 0000
 PORTC = 0x00; //m103 output only
 DDRC  = 0x00;
// PORTD = 0xFF;//0xD0;//1101 0000
// DDRD  = 0xFF;//0xD0;//1101 0000
// PORTE = 0xFE;//1111 1110
// DDRE  = 0xFE;//1111 1110
  PORTE = 0xFE;//µÆ2£¬PE2
 DDRE  = 0xFE;
// PORTF = 0xFF;//0x00;
// DDRF  = 0xFF;//0x00;
// PORTG = 0x1F;//0x00;
// DDRG  = 0x1F;//0x00;
///////////////
// PORTB = 0xF0;//1111 0000
// DDRB  = 0xF0;//1111 0000
 PORTB = 0xF4;//µÆ1£¬PB2£¬&&&&&&&&&&&&&&&&&&
 DDRB  = 0xF4;
// PORTD = 0xD0;//1101 0000
// DDRD  = 0xD0;//1101 0000
 PORTD=0xfc;//0xfc;//xxxx xx00
 DDRD=0xfc;//xxxx xx00
 //PORTF = 0x00;
 //DDRF  = 0x00;
 PORTF = 0xFF;
 DDRF  = 0x0F;

 
 PORTG = 0x00;
 DDRG  = 0x00;


}

//*****************************TIMER3 ³õÊ¼»¯***************************
void timer3_init(void)
{
 TCCR3B= 0x00; //stop
 TCNT3H= 0x00 /*INVALID SETTING*/; //setup
 TCNT3L= 0x00 /*INVALID SETTING*/;
 OCR3AH= 0x00 /*INVALID SETTING*/;
 OCR3AL= 0x00;
 OCR3BH= 0x00 /*INVALID SETTING*/;
 OCR3BL= 0x00;
 OCR3CH= 0x00 /*INVALID SETTING*/;
 OCR3CL= 0x00;
 TCCR3A= 0xFE;
 TCCR3B= 0x1A; //start TimerÓÃ8·ÖÆµ,¿ìËÙPWMÄ£Ê½
}

//*****************************TIMER1 ³õÊ¼»¯***************************
void timer1_init(void)
{
 TCCR1B= 0x00; //stop
 TCNT1H= 0x00 /*INVALID SETTING*/; //setup
 TCNT1L= 0x00 /*INVALID SETTING*/;
 OCR1AH= 0x00 /*INVALID SETTING*/;
 OCR1AL= 0x00;
 OCR1BH= 0x00 /*INVALID SETTING*/;
 OCR1BL= 0x00;
 OCR1CH= 0x00 /*INVALID SETTING*/;
 OCR1CL= 0x00;
 TCCR1A= 0xFE;
 TCCR1B= 0x1A; //start TimerÓÃ8·ÖÆµ,¿ìËÙPWMÄ£Ê½
}




void uart0_init(void)
{
 UCSR0B = 0x00; //disable while setting baud rate
 UCSR0A = 0x00;
 UCSR0C = 0x06;       //*½ÓÊÜºÍ·¢ËÍÊı¾İÖ¡µÄÊı¾İÎ»×Ö·û³¤¶È±£Áô
 
 UBRR0H = 0x00; //set baud rate hi
 UBRR0L = 0x33; //set baud rate lo
  
 UCSR0A = 0x00; //enable
 UCSR0B = 0x98;
}

//*************************initialize all peripherals***************
void init_devices(void)
{
 //stop errant interrupts until set up
 CLI(); //disable all interrupts,ÆÁ±ÎËùÓĞÖĞ¶Ï
 XDIV  = 0x00; //xtal divider,ÏµÍ³Ê±ÖÓ·ÖÆµ¿ØÖÆ¼Ä´æÆ÷
 XMCRA = 0x00; //external memory£¬Íâ²¿À©Õ¹´æ´¢Æ÷¿ØÖÆ¼Ä´æÆ÷A
 port_init();//¶Ë¿Ú³õÊ¼»¯
 //timer3_init();//¶¨Ê±Æ÷3³õÊ¼»¯
 //timer1_init();//¶¨Ê±Æ÷1³õÊ¼»¯
 uart0_init();//´®¿ÚÍ¨ĞÅÖĞ¶Ï
 MCUCR = 0x00;//MCU¿ØÖÆ¼Ä´æÆ÷£¬57Ò³
 //EICRA = 0x03; //extended ext ints£¬Íâ²¿ÖĞ¶Ï¿ØÖÆ¼Ä´æÆ÷A
 EICRA=0x00;
 EICRB = 0x00; //extended ext ints£¬Íâ²¿ÖĞ¶Ï¿ØÖÆ¼Ä´æÆ÷B
 //EIMSK = 0x01;//Íâ²¿ÖĞ¶ÏÆÁ±Î¼Ä´æÆ÷
 EIMSK = 0x00;
// TIMSK = 0x00; //timer interrupt sources£¬T/CÖĞ¶ÏÆÁ±Î¼Ä´æÆ÷
 TIMSK = 0x44;
 ETIMSK = 0x04; //extended timer interrupt sources£¬À©Õ¹T/CÖĞ¶ÏÆÁ±Î¼Ä´æÆ÷
 SEI(); //re-enable interrupts
}



 

void senddata(unsigned char data)
{
   /* µÈ´ı·¢ËÍ»º³åÆ÷Îª¿Õ */
   while (!( UCSR0A & (1<<UDRE0)))
   ;
   /* ½«Êı¾İ·ÅÈë»º³åÆ÷£¬·¢ËÍÊı¾İ*/
     UDR0 = data;
}


void uart_putchar(char c) //·¢ËÍÒ»¸ö×Ö½Ú
{
   while( !( UCSR0A & (1<<UDRE0)))
      ;
   UDR0=c;
}

void uart_word(char String[])//·¢ËÍÒ»¸ö×Ö·û´®
{
   int i;
   while(String[i]!='\0') 
   {
      uart_putchar(String[i]);
	  i++;
   }
}


//*********************sin¼ÆËã***************************
double Sin(unsigned char instant, unsigned char speed, int Offset_degree)
{

	double x,y;
	double temp;
        if(speed == 0)
          return 0;
        else
        {
          x = PI *2.0 *  ((double)instant / (double)speed) - PI * (double)Offset_degree / 180.0;       
		 //100115 ¾ÔªÁ¼ ½â¾öÖÍºó½Ç³¬¹ıÒ»¶¨·¶Î§ºó£¬µç»úµÄ¶¶¶¯ÎÊÌâ         
         if(x>(2.0*PI))
            x=x-2.0*PI;
        else if(x<0.0)
            x=x+2.0*PI;

		  if(x<=(PI/2.0))
		y=x-x*x*x/6.0;//sinx,ÕıÊı

          if(x>(PI/2.0)&&x<=PI)
	   {
		temp=PI-x;
		y=temp-temp*temp*temp/6.0;//ÕıÊı
	   }

          if(x>PI&&x<=(PI*3.0/2.0))
	   {
		temp=x-PI;
		y=temp*temp*temp/6.0-temp;//¸ºÊı
	   }

	  if(x>(PI*3.0/2.0))
	   {
	        temp=2.0*PI-x;
	        y=temp*temp*temp/6.0-temp;//¸ºÊı
	   }

	 return y;

        }
}

//**********************************¾²Ì¬Æ«ÒÆ×ª»»Îª¿ØÖÆÁ¿*************************
void init_static_offset(void)//À¨ºÅÄÚÌí¼Óvoid
{
  unsigned char i;

  for(i=0; i<Joint_Num; i++)
  {
       Static_Offset_value[i] =((int) ((Static_Offset_degree[i] * 10) * FLK)>>3)-1;//1¶È10us
  }
}

//**********************************¶¯Ì¬Æ«ÒÆ×ª»»Îª¿ØÖÆÁ¿*************************
void init_dynamic_offset(void)//À¨ºÅÄÚÌí¼Óvoid
{
  unsigned char i;
  
   for(i=0; i<Joint_Num; i++)
   {
   Dynamic_Offset_value[i] = ((int) ((Dynamic_Offset_degree[i] * 10) * FLK)>>3)-1;
   }
}
//***********************************¼ÆËã×îÖÕ¿ØÖÆÁ¿******************************

void calculate_data(void)   //Ëã³öÃ¿´ÎÒç³öÖĞ¶Ï¸Ä¶¯µÄOCRnXÖµ//À¨ºÅÄÚÌí¼Óvoid
{
  unsigned char i;
  if(d_change_t_v==1)//*·½Ïò¸Ä±äÊ±ÖÃ1£¬½«ÊµÊ±Æ«ÒÆ½Ç¸³¸ølast×÷ÎªÇ°Ò»×´Ì¬Æ«ÒÆ½Ç
  {
     d_change_t_v=0;
	 for(i=0;i<Joint_Num;i++)
	 {
	   Dynamic_Offset_value_last[i]=Dynamic_Offset_value_t[i];
     }
  }
  if((d_change_t==1)&&(t_dynamic>0)&&(t_dynamic<=(Speed_dynamic/2)))//¹ı¶É×´Ì¬
   {
      for(i=0;i<Joint_Num;i++)
	  {
	    Dynamic_Offset_value_per[i]=(Dynamic_Offset_value[i]-Dynamic_Offset_value_last[i])/(Speed_dynamic/2);
	    Dynamic_Offset_value_t[i]=Dynamic_Offset_value_last[i]+(Dynamic_Offset_value_per[i])*t_dynamic;
	  }
      for(i=0; i< Joint_Num; i++)
       Joint_Angle_value[i] =MiddlePosition_value + Static_Offset_value[i]+Dynamic_Offset_value_t[i]+  ((int) (Amplitude_degree[i] * Sin( Instant, Speed, Neighbouring_Offset_degree[i]) *10*FLK)>>3)-1;
    }
   else//ÎÈ¶¨×´Ì¬
   {
      d_change_t=0;
      for(i=0; i< Joint_Num; i++)
        Joint_Angle_value[i] =MiddlePosition_value + Static_Offset_value[i]+Dynamic_Offset_value[i]+  ((int) (Amplitude_degree[i] * Sin( Instant, Speed, Neighbouring_Offset_degree[i]) *10*FLK)>>3)-1;
   }  
}  //×îÖÕÒç³öÖĞ¶ÏĞ´Èë¼Ä´æÆ÷µÄÖµ

//*ÈçºÎ»»ËãµÄ£¬×÷ÓÃÊÇÊ²Ã´£¿

//***********************************¸÷Ê±¼äÁ¿×ª»»Îª¿ØÖÆÁ¿************************
void init_data(void)    // void init_data() ¸ÄÎªvoid init_data(void) wsg20120907
{
  PWM_Period_value=((int)(PWM_Period_ms*1000*FLK)>>3)-1; //pwmÖÜÆÚ 20ms»»Ëã³É¼ÆÊıÆ÷Öµ
  MiddlePosition_value=((int)(PWM_Duty_Middle_us*FLK )>>3)-1; //1500us ÖĞ¼äÎ»ÖÃ»»³É¼ÆÊıÖµ
  LeftLimit_value=((int)(PWM_Duty_LeftLimit_us*FLK)>>3)-1; //900us ×ó¼«ÏŞÎ»ÖÃ¼ÆÊıÆ÷Öµ£¬60¶È  1¶È10us
  RightLimit_value=((int)(PWM_Duty_RightLimit_us*FLK)>>3)-1; //2100us ÓÒ¼«ÏŞÎ»ÖÃ¼ÆÊıÆ÷Öµ£¬60¶È
}
	
//********************½«unsigned charĞÍÊı×ª»¯ÎªintĞÍÊı**************************
//flag=1Ê±×ªÎª¸ºÊı£¬×ó×ª£»flag=0Ê±×ªÎªÕıÊı£¬ÓÒ×ª
int char2int(unsigned char a_char,unsigned char a_flag)
{
  int a_int;
  if(a_flag==0)
  {
     a_int=a_char;
  }
  if(a_flag==1)
  {
     a_int=a_char;
	 a_int=-a_int;
  }
return a_int;
}



//*********************Ò»¸ö16Î»Êı×é£¬²ğÎª2¸ö8Î»Êı×é****************************
//½«³¤¶ÈÎª16Î»µÄÊı×édata_init[16]²ğ³É2¸ö³¤¶ÈÎª8µÄÊı×é
//·Ö±ğÎªdata_a[8],data_b[8]
//unsigned charĞÍ
void one2two(unsigned char *data_init,unsigned char *data_a,unsigned char *data_b)
{
  for(s=0;s<=7;s++)
   {
   data_a[s]=data_init[s];
   }
  for(s=8;s<=15;s++)
   {
   data_b[s-8]=data_init[s];
   }
}

//*******************½«2¸ö8Î»Êı×éÒÀË³Ğò×é³ÉÒ»¸ö16Î»Êı×é************************
//½«2¸ö³¤¶ÈÎª8µÄÊı×édata_aa[8],data_bb[8]
//Ë³´Î×é³ÉÒ»¸ö³¤¶ÈÎª16Î»µÄÊı×édata_inits[16]
//unsigned charĞÍ
void two2one(unsigned char *data_inits,unsigned char *data_aa,unsigned char *data_bb)
{
  for(s=0;s<=7;s++)
   {
   data_inits[s]=data_aa[s];//*°Ñdata_aaÊıÖµË³´Î¸³Öµ¸ødata_inits
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+8]=data_bb[s];//*°Ñdata_bbÊıÖµË³´Î¸³Öµ¸ødata_bbµÄ¸ß°ËÎ»
   }
}

//*********************Ò»¸ö24Î»Êı×é£¬²ğÎª3¸ö8Î»Êı×é****************************
//½«³¤¶ÈÎª32Î»µÄÊı×édata_init[24]²ğ³É3¸ö³¤¶ÈÎª8µÄÊı×é
//·Ö±ğÎªdata_a[8],data_b[8],data_c[8]
//unsigned charĞÍ
void one2three(unsigned char *data_init,unsigned char *data_a,unsigned char *data_b,unsigned char *data_c)
{
  for(s=0;s<=7;s++)
   {
   data_a[s]=data_init[s];//*°Ñdata_init[]µÄÇ°°ËÎ»ĞÎ³ÉÒ»¸öĞÂµÄÊı×édata_a[]
   }
  for(s=8;s<=15;s++)
   {
   data_b[s-8]=data_init[s];//*°Ñdata_init[]µÚ¾ÅÎ»µ½µÚÊ®ÁùÎ»ĞÎ³ÉÒ»¸öĞÂµÄÊı×édata_b[]
   }
  for(s=16;s<=23;s++)
   {
   data_c[s-16]=data_init[s];//*°Ñdata_init[]µÚÊ®ÆßÎ»µ½µ½µÚ¶şÊ®ËÄÎ»ĞÎ³ÉÒ»¸öĞÂµÄÊı×édata_c[]
   }
}

//*******************½«3¸ö8Î»Êı×éÒÀË³Ğò×é³ÉÒ»¸ö24Î»Êı×é************************
//½«3¸ö³¤¶ÈÎª24µÄÊı×édata_aa[8],data_bb[8],data_cc[8]
//Ë³´Î×é³ÉÒ»¸ö³¤¶ÈÎª32Î»µÄÊı×édata_inits[32]
//unsigned charĞÍ
void three2one(unsigned char *data_inits,unsigned char *data_aa,unsigned char *data_bb,unsigned char *data_cc)
{
  for(s=0;s<=7;s++)
   {
   data_inits[s]=data_aa[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+8]=data_bb[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+16]=data_cc[s];
   }
}


//*********************Ò»¸ö48Î»Êı×é£¬²ğÎª6¸ö8Î»Êı×é****************************
//½«³¤¶ÈÎª48Î»µÄÊı×édata_init[48]²ğ³É6¸ö³¤¶ÈÎª8µÄÊı×é
//·Ö±ğÎªdata_a[8],data_b[8],data_c[8],data_d[8],data_e[8],data_f[8]
//unsigned charĞÍ
void one2six(unsigned char *data_init,unsigned char *data_a,unsigned char *data_b,unsigned char *data_c,unsigned char *data_d,unsigned char *data_e,unsigned char *data_f)
{
  for(s=0;s<=7;s++)
   {
   data_a[s]=data_init[s];
   }
  for(s=8;s<=15;s++)
   {
   data_b[s-8]=data_init[s];
   }
  for(s=16;s<=23;s++)
   {
   data_c[s-16]=data_init[s];
   }
  for(s=24;s<=31;s++)
   {
   data_d[s-24]=data_init[s];
   }
  for(s=32;s<=39;s++)
   {
   data_e[s-32]=data_init[s];
   }
  for(s=40;s<=47;s++)
   {
   data_f[s-40]=data_init[s];
   }
}

//*******************½«6¸ö8Î»Êı×éÒÀË³Ğò×é³ÉÒ»¸ö48Î»Êı×é************************
//½«6¸ö³¤¶ÈÎª8µÄÊı×édata_aa[8],data_bb[8],data_cc[8],data_dd[8]
//Ë³´Î×é³ÉÒ»¸ö³¤¶ÈÎª48Î»µÄÊı×édata_inits[48]
//unsigned charĞÍ
void six2one(unsigned char *data_inits,unsigned char *data_aa,unsigned char *data_bb,unsigned char *data_cc,unsigned char *data_dd,unsigned char *data_ee,unsigned char *data_ff)
{
  for(s=0;s<=7;s++)
   {
   data_inits[s]=data_aa[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+8]=data_bb[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+16]=data_cc[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+24]=data_dd[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+32]=data_ee[s];
   }
  for(s=0;s<=7;s++)
   {
   data_inits[s+40]=data_ff[s];
   }
}



// d_tem 0  1  2  3  4  5  6  7  8  9  10  11  12  13  14  15 //7Ç°×ó£¬ºóÓÒ
//dd_tem 0  1  2  3  4  5  6  7  6  5  4   3   2   1   0   0 //¼Ó¸ººÅ×ó
//********************·ù¶Èµµd_tem×ª»¯Îª×óÓÒÍ³Ò»µÄdd_tem****************
//flag_c=1Ê±£¬×ó×ªd_cĞ¡ÓÚ7£¬¼Ó¸ººÅ£¬flag_c=0£¬ÓÒ×ªd_c´óÓÚµÈÓÚ7
unsigned char change_dd(unsigned char d_c)
{
   unsigned char dd_c;
   if((d_c>=0)&&(d_c<=7))
   {
     dd_c=d_c;
   }
   if((d_c>=7)&&(d_c<=14))
   {
     dd_c=7-(d_c-7);//14-d_c
   }
   if(d_c==15)
   {
     dd_c=0;
   }
return dd_c;
}
unsigned char change_flag(unsigned char d_c)
{
   unsigned char flag_c;
   if(d_c<=6)
   {
   flag_c=1;
   }
   else
   {
   flag_c=0;
   }
   return flag_c;
}


//********************************¶ÁĞ´i2c****************************************
//Ğ´i2c
//½«³¤¶ÈÎªdata_lµÄdata_temÊı×éĞ´ÈëµØÖ·Îªi2c_addressµÄdata_i2cÊı×é
//unsigend charĞÍ
void i2c_write(unsigned char i2c_address,unsigned char *data_i2c,unsigned char *data_tem,unsigned char data_l)
{
      int i=0;
	  data_i2c[0]=SLA_W;
	  data_i2c[1]=i2c_address;
	  for(i=0;i<=data_l-1;i++)
	  {
	     data_i2c[i+2]=data_tem[i];
	  }
	  TWI_Start_Transceiver_With_Data(data_i2c,data_l+2);
}

//¶Ái2c
//½«³¤¶ÈÎªdata_lµÄµØÖ·Îªi2c_addressµÄdata_i2cÊı×é¶Á³öµ½data_tem
//unsigned charĞÍ
void i2c_read(unsigned char i2c_address,unsigned char *data_i2c,unsigned char *data_tem,unsigned char data_l)
{
      int i=0;
	  data_i2c[0]=SLA_W;
	  data_i2c[1]=i2c_address;
	  TWI_Start_Transceiver_With_Data(data_i2c,2);
	  data_i2c[0]=SLA_R;
	  TWI_Start_Transceiver_With_Data(data_i2c,data_l+1);
	  TWI_Get_Data_From_Transceiver(data_i2c,data_l+1);
	  for(i=0;i<=data_l-1;i++)
	  {
	     data_tem[i]=data_i2c[i+1];
	  }			    	
}


//***********************µÚÒ»´ÎÊ¹ÓÃi2c£¬Êı¾İ³õÊ¼»¯*******************************
void i2c_init(void)
{	
      int i;
	  senddata(0xab);
	  switch(redata_i2c&0x0f)
	  {
	    case 0x01://FISHID ÉèÎª0x01;
		          i2c_write(ADD_i,FISHID_I2C,FISHID_init,1); 
				  break;
		case 0x02://ÆµÂÊÉèÎªÆµÂÊ1
		          i2c_write(ADD_f,freqs_I2C,freqs_init,1);
				  break;
	    case 0x03://µ÷Ö±Êı¾İ
		          i2c_write(ADD_t,degree_I2C,Static_Offset_degree_init,3);
				  break;
		case 0x04://Speed_tem[16]ËÙ¶È£¬s_tem
		          one2two(Speed_tem_init,Speed_tem_init1,Speed_tem_init2);
		          i2c_write(ADD_s1,Speed_tem_I2C1,Speed_tem_init1,8);
				  delay_nms(200);
		          i2c_write(ADD_s2,Speed_tem_I2C2,Speed_tem_init2,8);
				  break;
	    case 0x05://Neighbouring_Offset_degree[3]ÖÍºó½Ç
			      i2c_write(ADD_d,Neighbouring_Offset_degree_I2C,Neighbouring_Offset_degree_init,3);	         
				  break;
	    case 0x06://Amplitude_degree_tem[16][3]°Ú·ù,s_tem
		          one2six(Amplitude_degree_tem_init,Amplitude_degree_tem_init1,Amplitude_degree_tem_init2,Amplitude_degree_tem_init3,Amplitude_degree_tem_init4,Amplitude_degree_tem_init5,Amplitude_degree_tem_init6);
				  i2c_write(ADD_1,Amplitude_degree_tem_I2C1,Amplitude_degree_tem_init1,8);//+++++++
				  delay_nms(200);
				  i2c_write(ADD_2,Amplitude_degree_tem_I2C2,Amplitude_degree_tem_init2,8);//+++++++
     			  break;
		case 0x07:
				  i2c_write(ADD_3,Amplitude_degree_tem_I2C3,Amplitude_degree_tem_init3,8);//+++++++
				  delay_nms(200);
				  i2c_write(ADD_4,Amplitude_degree_tem_I2C4,Amplitude_degree_tem_init4,8);
				  break;
		case 0x08:
				  i2c_write(ADD_5,Amplitude_degree_tem_I2C5,Amplitude_degree_tem_init5,8);
				  break;
		case 0x09:
				  i2c_write(ADD_6,Amplitude_degree_tem_I2C6,Amplitude_degree_tem_init6,8);				  
                  break;
	    case 0x0A://Dynamic_Offset_degree_origin[8][3]×ªÍäÆ«ÒÆ½Ç,d_tem
		          one2three(Dynamic_Offset_degree_origin_init,Dynamic_Offset_degree_origin_init1,Dynamic_Offset_degree_origin_init2,Dynamic_Offset_degree_origin_init3);
				  i2c_write(ADD_10,Dynamic_Offset_degree_origin_I2C1,Dynamic_Offset_degree_origin_init1,8);//+++++++
     			  break;
		case 0x0B:
				  i2c_write(ADD_20,Dynamic_Offset_degree_origin_I2C2,Dynamic_Offset_degree_origin_init2,8);//+++++++
				  delay_nms(200);
				  i2c_write(ADD_30,Dynamic_Offset_degree_origin_I2C3,Dynamic_Offset_degree_origin_init3,8);
				  break;
	    case 0x0C:
				  delay_nms(200);
		         //¶Ái2cÊı¾İ
				 i2c_read(ADD_i,FISHID_I2C,FISHID,1);
     			 i2c_read(ADD_f,freqs_I2C,freqs,1);
	 			 //PORTD=freq[freqs[0]];
	 			 i2c_read(ADD_t,degree_I2C,Static_Offset_degree,3);
	 			 i2c_read(ADD_s1,Speed_tem_I2C1,Speed_tem_z1,8);
	 			 i2c_read(ADD_s2,Speed_tem_I2C2,Speed_tem_z2,8);
				 two2one(Speed_tem_z,Speed_tem_z1,Speed_tem_z2);
				 for(i=0;i<=15;i++)
				 {
                     Speed_tem[i]=Speed_tem_z[i];
				 }
	 			 i2c_read(ADD_d,Neighbouring_Offset_degree_I2C,Neighbouring_Offset_degree,3);
	 			 i2c_read(ADD_1,Amplitude_degree_tem_I2C1,Amplitude_degree_tem_z1,8);
	 			 i2c_read(ADD_2,Amplitude_degree_tem_I2C2,Amplitude_degree_tem_z2,8);
	 			 i2c_read(ADD_3,Amplitude_degree_tem_I2C3,Amplitude_degree_tem_z3,8);
	 			 i2c_read(ADD_4,Amplitude_degree_tem_I2C4,Amplitude_degree_tem_z4,8);
	 			 i2c_read(ADD_5,Amplitude_degree_tem_I2C5,Amplitude_degree_tem_z5,8);
	 			 i2c_read(ADD_6,Amplitude_degree_tem_I2C6,Amplitude_degree_tem_z6,8);
	 			 six2one(Amplitude_degree_tem_z,Amplitude_degree_tem_z1,Amplitude_degree_tem_z2,Amplitude_degree_tem_z3,Amplitude_degree_tem_z4,Amplitude_degree_tem_z5,Amplitude_degree_tem_z6);  
	 			   for(i=0;i<=47;i++)
	   			   {
	   			     Amplitude_degree_tem[i/3][i%3]=Amplitude_degree_tem_z[i];
	   			   }	
	 			 i2c_read(ADD_10,Dynamic_Offset_degree_origin_I2C1,Dynamic_Offset_degree_origin_z1,8);
	 			 i2c_read(ADD_20,Dynamic_Offset_degree_origin_I2C2,Dynamic_Offset_degree_origin_z2,8);
	 			 i2c_read(ADD_30,Dynamic_Offset_degree_origin_I2C3,Dynamic_Offset_degree_origin_z3,8);
	 			 three2one(Dynamic_Offset_degree_origin_z,Dynamic_Offset_degree_origin_z1,Dynamic_Offset_degree_origin_z2,Dynamic_Offset_degree_origin_z3);  
	  			   for(i=0;i<=23;i++)
	   			   {
	     		     Dynamic_Offset_degree_origin[i/3][i%3]=Dynamic_Offset_degree_origin_z[i];
	  			   }	
				senddata(0xcc);
		    	 break;
	  }
}


//***********************************´®¿ÚÖĞ¶Ï*****************************
#pragma interrupt_handler uart0_rx_isr:19
void uart0_rx_isr(void) 
{
       redata=UDR0;
	   if(1)//?//ÅĞ¶Ï¼Ä´æÆ÷µÄÖµ£¬ÊÇ·ñ´æÔÚ
	   {
		 if(isSrlStart)//ÈôÒÑ¾­·¢ËÍ¿ªÊ¼Î»£¬ÅĞ¶ÏµØÖ·ÂëÊÇ·ñÆ¥Åä
		 {
		   if(addr)//ÈôµØÖ·ÂëÒÑ¾­Æ¥Åä£¬×¼±¸½ÓÊÕÃüÁî
		   {
			   if(isInstruction==1|y_changing)//ÒÑ¾­½ÓÊÜ¹ıÃüÁîÁË£¬ÄÇÃ´ÅĞ¶ÏÊÇ·ñÊÇ½áÊøÎ»
			   {
				   if(redata==0xfc)
				   { 
					   e_change=1;//
					   is_uart=1;//ÍË³ö×Ô¶¯Ä£Ê½£¬½øÈëÊÖ¶¯¿ØÖÆÄ£Ê½
				   }
				   else//½ÓÊÕµ½µÄ²»ÊÇ½áÊøÎ»£¬ÄÇÃ´ÕâÌõÖ¸ÁîÎŞĞ§£¬ÖØĞÂ½ÓÊÕÏÂÒ»´ÎÃüÁî
				   {
			  	      isSrlStart=0;
					  addr=0;
					  isInstruction=0;
				   }
			   }
			   else//Ã»ÓĞ½ÓÊÜ¹ıÃüÁî£¬Ôò½ÓÊÜÃüÁî
			   {
				   switch(redata&0xf0)
				   {
				   case 0xD0://ËÙ¶È
					   redata_fan=redata;
					   s_change=1;
					   m_change=0;
					   y_change=0;
					   isInstruction=1;
					   redata_tem=redata;
					   break;
				   case 0xE0://·½Ïò
			            redata_fan=redata;
						d_change=1;
						//d_change_t=1;
						//d_change_t_v=1;
						m_change=0;
						y_change=0;
						isInstruction=1;
						redata_tem=redata;
						break;
				   case 0x00://µ÷Ö±
			            t_change=1;
						m_change=0;
						y_change=0;
						isInstruction=1;
						redata_tem=redata;
						break;
				   case 0x10://µ÷Ö±ÊÇ·ñ±£´æ
			            ts_change=1;
						m_change=0;
						y_change=0;
						isInstruction=1;
						redata_tem=redata;
						break;
				   case 0x20://¸ü¸ÄÓãid
			            id_change++;
						m_change=0;
						y_change=0;
						isInstruction=1;
						redata_tem=redata;
						break;
				   case 0x40://¸ü¸ÄÆµÂÊ
			            f_change=1;
						m_change=0;
						y_change=0;
						isInstruction=1;
						redata_tem=redata;
						//PORTD=0xf4;						
						break;
				   case 0x70:///¸ü¸ÄÄ£Ì¬
			            m_change=1;
						y_change=0;
						m_cishu=0;
						mm_cishu=0;
						mmm_cishu=m_time-1;
						isInstruction=1;
						m_tem=redata;
						break;
				   case 0x30://Ô­Ê¼µÄ×ªÍäÄ£Ê½
			            y_change=1;
                        y_changing=1;
						m_change=0;
						y_cishu=0;
						yy_cishu=0;
						yyy_cishu=y_time-1;
						cishu_y=0;
						y_tem=redata;
						switch(y_tem)//×ªÍäµµ²»Í¬£¬±£³ÖµÄÊ±¼ä²»Í¬£¬ÍäÔ½´ó£¬Ê±¼äÔ½³¤¡£
						{
						case 0:
							yy_time=0xff;
						case 1:
							yy_time=0xf0;
						case 2:
							yy_time=0xe0;
						case 3:
							yy_time=0xd0;
						case 4:
							yy_time=0xc0;
						case 5:
							yy_time=0xb0;
						case 6:
							yy_time=0xa0;
						case 15:
							yy_time=0xff;
						case 14:
							yy_time=0xff;
						case 13:
							yy_time=0xf0;
						case 12:
							yy_time=0xe0;
						case 11:
							yy_time=0xd0;
						case 10:
							yy_time=0xc0;
						case 9:
							yy_time=0xb0;
						case 7:
							y_change=0;
						}
						y_speed=Speed;					
						isInstruction=1;
						break;
/*			       case 0xb0://¸ü¸Ä·ù¶È
			            a_change=1;
						m_change=0;
						y_change=0;
						redata_tem=redata;
						break;
*/
	/////////----²âÊÔÖ¸Áî--BEGIN----//////////////

			       case 0x50:
						isInstruction=1;
			  	   		if(redata==0x55)//·µ»ØËÙ¶È·ù¶ÈÖµ
						{
			  			 senddata(0x11);//ÆğÊ¼±êÖ¾Î»
			  			 senddata(FISHID[0]);//ÓãµÄidºÅ£¬ 
			  			 senddata(freqs[0]+1);//ÆµÂÊµµ£¬1-4
			  			 senddata(Static_Offset_degree[0]);//µÚÒ»¹Ø½Úµ÷Ö±Êı¾İ
			  			 senddata(Static_Offset_degree[1]);//µÚ¶ş¹Ø½Úµ÷Ö±Êı¾İ
			  			 senddata(Static_Offset_degree[2]);//µÚÈı¹Ø½Úµ÷Ö±Êı¾İ
			  			 senddata(s_tem);//ËÙ¶Èµµ£¬¶ÔÓ¦ËÙ¶È¡¢·ù¶È
			  			 senddata(Speed);//ËÙ¶ÈÖµ
			  			 senddata(Amplitude_degree[0]);//µÚÒ»¹Ø½Ú°Ú·ù
			  			 senddata(Amplitude_degree[1]);//µÚ¶ş¹Ø½Ú°Ú·ù
			  			 senddata(Amplitude_degree[2]);//µÚÈı¹Ø½Ú°Ú·ù
			  			 senddata(d_tem);//·½Ïòµµ£¬¶ÔÓ¦×ªÍäÆ«ÒÆ½Ç¶È
			  			 senddata(flag);//×ó×ª»¹ÊÇÓÒ×ª
			  			 senddata(Dynamic_Offset_degree_char[0]);//µÚÒ»¹Ø½Ú×ªÍäÆ«ÒÆ½Ç¶È
			  			 senddata(Dynamic_Offset_degree_char[1]);//µÚ¶ş¹Ø½Ú×ªÍäÆ«ÒÆ½Ç¶È
			  			 senddata(Dynamic_Offset_degree_char[2]);//µÚÈı¹Ø½Ú×ªÍäÆ«ÒÆ½Ç¶È
			  			 senddata(Neighbouring_Offset_degree[0]);//0
			  			 senddata(Neighbouring_Offset_degree[1]);//µÚ¶ş¹Ø½ÚÖÍºó½Ç
			  			 senddata(Neighbouring_Offset_degree[2]);//µÚÈı¹Ø½ÚÖÍºó½Ç
						}//if(redata==0x55)	
						break;
				   case 0x60:
						isInstruction=1;
			            if(redata==0x66)//½«µ÷ÕûµÄ²ÎÊı±£´æµ½I2C
						{
			  			 i2c_canshu=1;
						}//if(redata==0x66)	
						break;
				   
				   case 0xb0:
						isInstruction=1;
			            if(redata==0xb1)//¸Äspeed
			            {
			            Speed--;
			  			Speed_tem_z[s_tem]=Speed;
						}//if(redata==0xb1)
						
						if(redata==0xb2)
						{
			 			Speed++;
			 		    Speed_tem_z[s_tem]=Speed;
						}//if(redata==0xb2)
						
						if(redata==0xb3)//µÚÒ»¹Ø½ÚÆ«ÒÆ½Ç£¬¼õ1
						{
			  			dd_tem=change_dd(d_tem);
			  			flag=change_flag(d_tem);
			  			 if(Dynamic_Offset_degree_char[0]==0)
			  			 {
						 }
			  			 else
			 			 {
			  			 Dynamic_Offset_degree_char[0]--;
			  			 }
			  			Dynamic_Offset_degree[0]=char2int(Dynamic_Offset_degree_char[0],flag);
			  			init_dynamic_offset();			  
			  			Dynamic_Offset_degree_origin[dd_tem][0]=Dynamic_Offset_degree_char[0];
					    }//if(redata==0xb3)
			
						if(redata==0xb4)//µÚÒ»¹Ø½ÚÆ«ÒÆ½Ç£¬¼Ó1
						{
			 			 dd_tem=change_dd(d_tem);
			 			 flag=change_flag(d_tem);
			  			 Dynamic_Offset_degree_char[0]++;
			  			 Dynamic_Offset_degree[0]=char2int(Dynamic_Offset_degree_char[0],flag);
			  			 init_dynamic_offset();			  
			  			 Dynamic_Offset_degree_origin[dd_tem][0]=Dynamic_Offset_degree_char[0];
						}//if(redata==0xb4)
			
						if(redata==0xb5)//µÚ¶ş¹Ø½ÚÆ«ÒÆ½Ç£¬¼õ1
						{
			  			 dd_tem=change_dd(d_tem);
			  			 flag=change_flag(d_tem);
			  			 if(Dynamic_Offset_degree_char[1]==0)
			  			 {
						 }
			  			 else
			  			 {
			  			 Dynamic_Offset_degree_char[1]--;
			  			 }
			  			Dynamic_Offset_degree[1]=char2int(Dynamic_Offset_degree_char[1],flag);
			  			init_dynamic_offset();			  
			  			Dynamic_Offset_degree_origin[dd_tem][1]=Dynamic_Offset_degree_char[1];
					   }//if(redata==0xb5)
			
					   if(redata==0xb6)//µÚ¶ş¹Ø½ÚÆ«ÒÆ½Ç£¬¼Ó1
					   {
			  		    dd_tem=change_dd(d_tem);
			  			flag=change_flag(d_tem);
			  			Dynamic_Offset_degree_char[1]++;
			  			Dynamic_Offset_degree[1]=char2int(Dynamic_Offset_degree_char[1],flag);
			  			init_dynamic_offset();			  
			  			Dynamic_Offset_degree_origin[dd_tem][1]=Dynamic_Offset_degree_char[1];
					   }//if(redata==0xb6)
			
					   if(redata==0xb7)//µÚÈı¹Ø½ÚÆ«ÒÆ½Ç£¬¼õ1
					   {
			  		    dd_tem=change_dd(d_tem);
			  			flag=change_flag(d_tem);
			  			if(Dynamic_Offset_degree_char[1]==0)
			  			{
						}
			  			else
			  			{
			  			 Dynamic_Offset_degree_char[1]--;
			  			}
			  		   Dynamic_Offset_degree[2]=char2int(Dynamic_Offset_degree_char[2],flag);
			  		   init_dynamic_offset();			  
			  		   Dynamic_Offset_degree_origin[dd_tem][2]=Dynamic_Offset_degree_char[2];
					   }//if(redata==0xb7)
			
					   if(redata==0xb8)//µÚÈı¹Ø½ÚÆ«ÒÆ½Ç£¬¼Ó1
					   {
			  		   dd_tem=change_dd(d_tem);
			  		   flag=change_flag(d_tem);
			  		   Dynamic_Offset_degree_char[2]++;
			  		   Dynamic_Offset_degree[2]=char2int(Dynamic_Offset_degree_char[2],flag);
			  		   init_dynamic_offset();			  
			  		   Dynamic_Offset_degree_origin[dd_tem][2]=Dynamic_Offset_degree_char[2];
					   }//if(redata==0xb8)								
					   senddata(redata); 
					   break;
			  

				   case 0xc0:
						isInstruction=1;
			           if(redata==0xc1)//¸ÄµÚÒ»¹Ø½Ú°Ú¶¯·ù¶È
					   {
			  		     if(Amplitude_degree[0]==0)
			  			 {
			  			 }
			  			 else
			  			 {
			  			 Amplitude_degree[0]--;
			  			 }
			  		   Amplitude_degree_tem[s_tem][0]=Amplitude_degree[0];//´æÎªµ±Ç°ËÙ¶ÈµµµÄ°Ú·ùÖµ
					   }//if(redata==0xc1)
					   
					   if(redata==0xc2)
					   {
			  		   	 if(Amplitude_degree[0]==90)
			 			 {
			  			 }
			  			 else
			  			 {
			  			 Amplitude_degree[0]++;
			  			 }
			  		  Amplitude_degree_tem[s_tem][0]=Amplitude_degree[0];
					  }//if(redata==0xc2)	
					  
					  if(redata==0xc3)//¸ÄµÚ¶ş¹Ø½Ú°Ú¶¯·ù¶È
					  {
			 		   if(Amplitude_degree[1]==0)
			     	   {
			 		   }
			 		   else
			           {
			  		   Amplitude_degree[1]--;
			  		   }
			  		  Amplitude_degree_tem[s_tem][1]=Amplitude_degree[1];
					  }//if(redata==0xc3)
					  
					  if(redata==0xc4)
					  {
			  		   if(Amplitude_degree[1]==90)//90=0x5A
			  		   {
			  		   }
			  		   else
			  		   {
			  		   Amplitude_degree[1]++;
			  		   }
			          Amplitude_degree_tem[s_tem][1]=Amplitude_degree[1];
					  }//if(redata==0xc4)	
					  
					  if(redata==0xc5)//¸ÄµÚÈı¹Ø½Ú°Ú¶¯·ù¶È
					  {
			 		   if(Amplitude_degree[2]==0)
			 		   {
			  		   }
			  		   else
			  		   {
			  		   Amplitude_degree[2]--;
			  		   }
			          Amplitude_degree_tem[s_tem][2]=Amplitude_degree[2];
					  }//if(redata==0xc5)
					  
					  if(redata==0xc6)
					  {
			           if(Amplitude_degree[2]==90)
			           {
			           }
			           else
			           { 
			 		   Amplitude_degree[2]++;
			  		   }
			         Amplitude_degree_tem[s_tem][2]=Amplitude_degree[2];
					 }//if(redata==0xc6)
					 
					 if(redata==0xc7)//µÚ¶ş¹Ø½Ú¼õÖÍºó½Ç
					 {
			  		  if(Neighbouring_Offset_degree[1]==0)
			  		  {
			  		  }
			  		  else
			  		  {
			  		  Neighbouring_Offset_degree[1]--;
			  		  }					  
					 }//if(redata==0xc7)
					 
					 if(redata==0xc8)//µÚ¶ş¹Ø½Ú¼ÓÖÍºó½Ç
					 {
			  		  if(Neighbouring_Offset_degree[1]==255)
			  		  {
			  		  }
			  		  else
			  		  {
			 		  Neighbouring_Offset_degree[1]++;
			  		  }
					 }//if(redata==0xc8)
					 
					 if(redata==0xc9)//µÚÈı¹Ø½Ú¼õÖÍºó½Ç
					 {
			  		  if(Neighbouring_Offset_degree[2]==0)
			  		  {
			  		  }
			  		  else
			  		  {
			  		  Neighbouring_Offset_degree[2]--;
			  		  }
					 }//if(redata==0xc9)
					 
					 if(redata==0xc0)//µÚÈı¹Ø½Ú¼ÓÖÍºó½Ç
					 {
			  		  if(Neighbouring_Offset_degree[2]==255)
			  		  {
			  		  }
			  		  else
			  		  {
			  		  Neighbouring_Offset_degree[2]++;
			  		  }
					 }//if(redata==0xc0)
					 senddata(redata);
					 break;

	/////////----²âÊÔÖ¸Áî--END----//////////////

			    case 0xf0://ÊÇ·ñ½áÊøÎ»
			            if(redata==0xfc)
						{
							e_change=1;//
							is_uart=1; //ÍË³ö×Ô¶¯Ä£Ê½£¬½øÈëÊÖ¶¯¿ØÖÆÄ£Ê½
						}//if(redata==0xfc)
						break;		
			    default://½ÓÊÕµ½µÄ²»ÊÇÖ¸ÁîÒ²²»ÊÇ½áÊøÎ»£¬ÖØĞÂ½ÓÊÕÏÂÒ»´ÎÃüÁî
			  	      isSrlStart=0;
					  addr=0;
			     }//switch(redata&0xf0)
			  } //if(isInstruction==1) else
			  
		   }//if(addr)
		   
		   else//µØÖ·ÂëÃ»½ÓÊÕ£¬»òÒÑ¾­½ÓÊÕµ«²»Æ¥Åä
		   {
		     if(redata==(0x90|FISHID[0]))//½ÓÊÕµØÖ·Âë£¬Æ¥Åä£¬ÖÃÎ»±êÖ¾Î»
			 {
			 addr=1;
			 }//if(redata==(0x90|FISHID))
			 
			 else//µØÖ·Âë²»Æ¥Åä£¬ÇåÁã¿ªÊ¼Î»±êÖ¾Î»£¬ÖØĞÂ½ÓÊÕÏÂÒ»´ÎÖ¸Áî
			 {
			 isSrlStart=0;
			 }//if(redata==(0x90|FISHID)) else
			 
		   }//if(addr) else
		   
		 }//if(isSrlStart)

	/////////----³õÊ¼»¯i2cµÄÍ¨ĞÅĞ­Òé--BEGIN----//////////////

		 else if(isSrlStartI2c)//ÈôÒÑ¾­·¢ËÍ³õÊ¼»¯i2cµÄÆğÊ¼Î»£¬ÅĞ¶ÏµØÖ·Âë£¨0x74£¬ÆğÈ·¶¨Ö¸ÁîµÄ×÷ÓÃ£©ÊÇ·ñÆ¥Åä
		 {
			 if(addrI2c)//ÈôµØÖ·ÂëÒÑ¾­Æ¥Åä£¬×¼±¸½ÓÊÕÃüÁî
			 {
				 if(isInstructionI2c)//ÒÑ¾­½ÓÊÜ¹ıÃüÁîÁË£¬ÄÇÃ´ÅĞ¶ÏÊÇ·ñÊÇ½áÊøÎ»
				 {
					 if(redata==0xfb)
					 {
						 i2c_change=1;
						 is_uart=1;
					 }
					 else//½ÓÊÕµ½µÄ²»ÊÇ½áÊøÎ»£¬ÄÇÃ´ÕâÌõÖ¸ÁîÎŞĞ§£¬ÖØĞÂ½ÓÊÕÏÂÒ»´ÎÃüÁî
					 {
						 isSrlStartI2c=0;
						 addrI2c=0;
						 isInstructionI2c=0;
					 }
				 }
				 else//Ã»ÓĞ½ÓÊÕÃüÁî£¬Ôò½ÓÊÕÃüÁî
				 {
					 switch(redata&0xf0)
					 {
					 case 0x80:
						 redata_i2c=redata;
						 i_change=1;
						 isInstructionI2c=1;
						 break;
					 case 0xfb:
						 if(redata==0xfb)
						 {
							 i2c_change=1;
							  is_uart=1;
						 }
						 break;
					 default:
						 isSrlStartI2c=1;
						 addrI2c=0;
						 break;
					 }
				 }					 
			 }


			 else//µØÖ·ÂëÃ»ÓĞ½ÓÊÕ£¬»òÕßÒÑ½ÓÊÕµ«²»Æ¥Åä
			 {
				 if(redata==0x74)//½ÓÊÕµØÖ·Âë£¬Æ¥Åä£¬ÖÃÎ»±êÖ¾Î»
				 {
					 addrI2c=1;
				 }
				 else//µØÖ·Âë²»Æ¥Åä£¬ÇåÁã¿ªÊ¼Î»±êÖ¾Î»£¬ÖØĞÂ½ÓÊÕÏÂÒ»´ÎÖ¸Áî
				 {
					 isSrlStartI2c=0;
				 }					
			 }
		 }
		 else
		 {
		    if(redata==0xaa)//ÅĞ¶ÏÆğÊ¼Î»£¬ÖÃÎ»±êÖ¾Î»
			{
			  isSrlStart=1;
			}
			if(redata==0xcc)//ÅĞ¶Ï³õÊ¼»¯i2cµÄÆğÊ¼Î»
			{
				isSrlStartI2c=1;
			}
		 }//if(isSrlStart) else

	/////////----³õÊ¼»¯i2cµÄÍ¨ĞÅĞ­Òé--END----//////////////

	}//if(1)
}


//***********************************¼ÆÊıÆ÷3Òç³öÖĞ¶Ï*****************************
#pragma interrupt_handler timer3_ovf_isr:30
void timer3_ovf_isr(void)
{
  unsigned char i;
  
 TCNT3H = 0x00 ; //reload counter high value  INVALID SETTING
 TCNT3L = 0x00 ; //reload counter low value   INVALID SETTING
 
 if(Speed!=0)   //¼´Ã»ÓĞÆô¶¯ÔòÒ»Ö±1500£¬ÖĞ¼äÎ»ÖÃ
 {
    Instant++;
  	Instant=Instant%Speed;
 }
 	t_dynamic++;
	if(t_dynamic>Speed)
	{
	  t_dynamic=Speed;
	}	
    calculate_data();
	OCR3A=Joint_Angle_value[2];
	/*wang genghai*/
	//OCR3B=Joint_Angle_value[2];	   
 
}

//***********************************¼ÆÊıÆ÷1Òç³öÖĞ¶Ï*****************************
#pragma interrupt_handler timer1_ovf_isr:15
void timer1_ovf_isr(void)
{
    unsigned char i;
  
    TCNT1H = 0x00 ; //reload counter high value  INVALID SETTING
    TCNT1L = 0x00 ; //reload counter low value   INVALID SETTING
 
    if(Speed!=0)   //¼´Ã»ÓĞÆô¶¯ÔòÒ»Ö±1500£¬ÖĞ¼äÎ»ÖÃ
    {
          Instant++;
		    //×¢Òâ£¬ÔÚÁ½¸ö¶¨Ê±Æ÷µÄÖĞ¶ÏÖĞ£¬¶¼Ôö¼ÓÁËInstant++£¬Êµ¼ÊÊÇ²»±ØÒªµÄ£¬Ö»ÔÚÒ»¸ö¶¨Ê±Æ÷ÖĞ¶Ï¼Ó¾Í¿ÉÒÔÁË¡£
	        //Á½´¦¶¼¼ÓºÍÖ»¼ÓÒ»´¦µÄÇø±ğ£¬Ö»ÊÇµç»úÔË¶¯¿ìÁË£¬ÒòÎªÁ½´¦¶¼¼Ó£¬Ïàµ±ÓÚÀëÉ¢µãµÄ¼ä¸ôÊÇÔ­À´µÄÒ»°ë£¨Ô­À´20ms£¬ÏÖÔÚ10ms£©¡£ÀíÂÛ·ÖÎöÊ±×¢Òâ¼´¿É£¬²»Ó°ÏìÊ¹ÓÃ¡£
	        //ÏêÏ¸½âÊÍ  £¨Ò»¸ö°Ú¶¯ÖÜÆÚT¶¨ÒåÎª ×ó±ß¡ª¡ªÖĞ¼ä¡ª¡ªÓÒ±ß¡ª¡ªÖĞ¼ä¡ª¡ª×ó±ß£©
	        //Ö»ÔÚÒ»´¦¼ÓInstant++£ºÒ»¸ö°Ú¶¯ÖÜÆÚ±»ÀëÉ¢Îªspeed·İ£¬Ã¿·İ¼ä¸ô20ms£¬¼´£¬T=£¨speed-1£©X20    ´ËÊ±×î¿ìËÙ¶ÈÊ±ÓÃspeed=23
	        //Á½´¦¶¼¼ÓInstant++£ºÒ»¸ö°Ú¶¯ÖÜÆÚ±»ÀëÉ¢Îªspeed·İ£¬Ã¿·İ¼ä¸ô20/2ms£¬¼´£¬T=£¨speed-1£©X10    ´ËÊ±×î¿ìËÙ¶ÈÊ±ÓÃspeed=45(ÓëÉÏÃæ23Ò»¸öĞ§¹û) 
	        //ÒÔÉÏ¼ÆËã¹«Ê½ÓĞÎó²î£¬ĞŞÕıÈçÏÂ¡ª¡ª09.06.25
			//Ö»ÔÚÒ»´¦¼ÓInstant++£ºÒ»¸ö°Ú¶¯ÖÜÆÚ±»ÀëÉ¢Îªspeed·İ£¬Ã¿·İ¼ä¸ô20ms£¬¼´£¬T=£¨speed£©X20    ´ËÊ±×î¿ìËÙ¶ÈÊ±ÓÃspeed=23
			//Á½´¦¶¼¼ÓInstant++£ºÒ»¸ö°Ú¶¯ÖÜÆÚ±»ÀëÉ¢Îªspeed·İ£¬Ã¿·İ¼ä¸ô20/2ms£¬¼´£¬T=£¨speed£©X10    ´ËÊ±×î¿ìËÙ¶ÈÊ±ÓÃspeed=45(ÓëÉÏÃæ23Ò»¸öĞ§¹û)
  	    Instant=Instant%Speed;
   }
    calculate_data(); 
	OCR1A=Joint_Angle_value[0];	 
	OCR1B=Joint_Angle_value[1];  
}
//*************************************************************************
//********************************Ö÷º¯Êı***********************************
//*************************************************************************
void main(void)
{   
     unsigned char i;
  	 unsigned char tem;
	 unsigned char tem_y;
	 unsigned char j; 
 	 init_devices();//³õÊ¼»¯
	 TWI_Master_Initialise(); //*IIC¿ØÖÆ³õÊ¼»¯
	 SEI();
     /////////////////////////////////////////////////////
	 //¶Ái2cÊı¾İ
	 i2c_read(ADD_i,FISHID_I2C,FISHID,1);
	 i2c_read(ADD_f,freqs_I2C,freqs,1);
	 //PORTD=freq[freqs[0]];
	 i2c_read(ADD_t,degree_I2C,Static_Offset_degree,3);
	 i2c_read(ADD_s1,Speed_tem_I2C1,Speed_tem_z1,8);
	 i2c_read(ADD_s2,Speed_tem_I2C2,Speed_tem_z2,8);
	 two2one(Speed_tem_z,Speed_tem_z1,Speed_tem_z2);
	 for(i=0;i<=15;i++)
	 {
	      Speed_tem[i]=Speed_tem_z[i];    //Speed_tem[i] = Speed_Amplitudeem_z[i];//Speed_Amplitudeem_z[i];//*ÎªÊ²Ã´»áÓĞ´í£¿£¿
	 }
	 i2c_read(ADD_d,Neighbouring_Offset_degree_I2C,Neighbouring_Offset_degree,3);
	 i2c_read(ADD_1,Amplitude_degree_tem_I2C1,Amplitude_degree_tem_z1,8);
	 i2c_read(ADD_2,Amplitude_degree_tem_I2C2,Amplitude_degree_tem_z2,8);
	 i2c_read(ADD_3,Amplitude_degree_tem_I2C3,Amplitude_degree_tem_z3,8);
	 i2c_read(ADD_4,Amplitude_degree_tem_I2C4,Amplitude_degree_tem_z4,8);
	 i2c_read(ADD_5,Amplitude_degree_tem_I2C5,Amplitude_degree_tem_z5,8);
	 i2c_read(ADD_6,Amplitude_degree_tem_I2C6,Amplitude_degree_tem_z6,8);
	 six2one(Amplitude_degree_tem_z,Amplitude_degree_tem_z1,Amplitude_degree_tem_z2,Amplitude_degree_tem_z3,Amplitude_degree_tem_z4,Amplitude_degree_tem_z5,Amplitude_degree_tem_z6);  
	 for(i=0;i<=47;i++)
	 {
		Amplitude_degree_tem[i/3][i%3]=Amplitude_degree_tem_z[i];
	 }	
	 i2c_read(ADD_10,Dynamic_Offset_degree_origin_I2C1,Dynamic_Offset_degree_origin_z1,8);
	 i2c_read(ADD_20,Dynamic_Offset_degree_origin_I2C2,Dynamic_Offset_degree_origin_z2,8);
	 i2c_read(ADD_30,Dynamic_Offset_degree_origin_I2C3,Dynamic_Offset_degree_origin_z3,8);
	 three2one(Dynamic_Offset_degree_origin_z,Dynamic_Offset_degree_origin_z1,Dynamic_Offset_degree_origin_z2,Dynamic_Offset_degree_origin_z3);  
	 for(i=0;i<=23;i++)
	 {
		Dynamic_Offset_degree_origin[i/3][i%3]=Dynamic_Offset_degree_origin_z[i];
     }
////////////////////////////////////////////////////
	 CLI();
	 timer3_init();
	 timer1_init();
	 SEI();
	 init_data();
	 init_static_offset();
	 calculate_data();
	 
	 CLI();
	 TCCR3B=0x00;		//ÔİÍ£¶¨Ê±£¯¼ÆÊıÆ÷3  ×îºóÁ½Î»ÉèÎª0¼´¿É
	 TCCR1B=0x00;		//ÔİÍ£¶¨Ê±£¯¼ÆÊıÆ÷3  ×îºóÁ½Î»ÉèÎª0¼´¿É
	
	 ICR3=PWM_Period_value;//¼ÆÊıÆ÷3ÉÏÏŞÖµTOP
	 ICR1=PWM_Period_value;//¼ÆÊıÆ÷1ÉÏÏŞÖµTOP
	 OCR1A=Joint_Angle_value[0];
	 OCR1B=Joint_Angle_value[1];
	 OCR3A=Joint_Angle_value[2];
	 /*wang genggai*/
	// OCR3B=Joint_Angle_value[2];
	 
	 SEI();         //re-enable interrupts
	 TCCR3B=0x1A;	//Æô¶¯¶¨Ê±£¯¼ÆÊıÆ÷3
	 TCCR1B=0x1A;	//Æô¶¯¶¨Ê±£¯¼ÆÊıÆ÷1
	 
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
	while(1)
	{
///////////----ÊÖ¶¯Ä£Ê½--BEGIN//////////////////////////////////////////
	   if(is_uart==1)//ÊÖ¶¯Ä£Ê½
	   {
	   if(i2c_canshu)
	   {
	     i2c_canshu=0;
		 baocun_i++;
		 switch(baocun_i)
		 {
		 case 1:
				one2two(Speed_tem_z,Speed_tem_z1,Speed_tem_z2);
		        i2c_write(ADD_s1,Speed_tem_I2C1,Speed_tem_z1,8);
				delay_nms(200);
		        i2c_write(ADD_s2,Speed_tem_I2C2,Speed_tem_z2,8);
		        senddata(baocun_i);
				break;
		 case 2:
		        i2c_write(ADD_d,Neighbouring_Offset_degree_I2C,Neighbouring_Offset_degree,3);//ÖÍºó½Ç
		        senddata(baocun_i);
				break;
		 case 3://·ù¶È
				for(i=0;i<=15;i++)
				{
				  for(j=0;j<=2;j++)
				  {
				    Amplitude_degree_tem_z[i*3+j]=Amplitude_degree_tem[i][j];
				  }
				}
				one2six(Amplitude_degree_tem_z,Amplitude_degree_tem_z1,Amplitude_degree_tem_z2,Amplitude_degree_tem_z3,Amplitude_degree_tem_z4,Amplitude_degree_tem_z5,Amplitude_degree_tem_z6);			
				i2c_write(ADD_1,Amplitude_degree_tem_I2C1,Amplitude_degree_tem_z1,8);
		        senddata(baocun_i);
				break;
		 case 4:
				i2c_write(ADD_2,Amplitude_degree_tem_I2C2,Amplitude_degree_tem_z2,8);
				delay_nms(200);
				i2c_write(ADD_3,Amplitude_degree_tem_I2C3,Amplitude_degree_tem_z3,8);
				senddata(baocun_i);
				break;
		 case 5:
				i2c_write(ADD_4,Amplitude_degree_tem_I2C4,Amplitude_degree_tem_z4,8);
				delay_nms(200);
				i2c_write(ADD_5,Amplitude_degree_tem_I2C5,Amplitude_degree_tem_z5,8);
		        senddata(baocun_i);
				break;
		 case 6:
				i2c_write(ADD_6,Amplitude_degree_tem_I2C6,Amplitude_degree_tem_z6,8);
				senddata(baocun_i);
    			break;
		 case 7://×ªÍäÆ«ÒÆ½Ç
				for(i=0;i<=7;i++)
				{
				  for(j=0;j<=2;j++) 
				  {
				    Dynamic_Offset_degree_origin_z[i*3+j]=Dynamic_Offset_degree_origin[i][j];
				  }
				}
				one2three(Dynamic_Offset_degree_origin_z,Dynamic_Offset_degree_origin_z1,Dynamic_Offset_degree_origin_z2,Dynamic_Offset_degree_origin_z3);			
				i2c_write(ADD_10,Dynamic_Offset_degree_origin_I2C1,Dynamic_Offset_degree_origin_z1,8);
		        senddata(baocun_i);
				break;
		 case 8:
				i2c_write(ADD_20,Dynamic_Offset_degree_origin_I2C2,Dynamic_Offset_degree_origin_z2,8);
				senddata(baocun_i);
				break;
		 case 9:baocun_i=0;
				i2c_write(ADD_30,Dynamic_Offset_degree_origin_I2C3,Dynamic_Offset_degree_origin_z3,8);
		        senddata(baocun_i);
				break;  
		 }//switch baocun_i		  
	   }//if(i2c_canshu)
	   	   
	   if(i2c_change)
	   {
			i2c_init();
			i2c_change=0;
			isSrlStartI2c=0;
			addrI2c=0;
			isInstructionI2c=0;
			i_change=0;
	   }//if(i2c_change)

	   if(e_change)//½ÓÊÕµ½½áÊøÎ»,´¦ÀíÖ¸Áî
	   {
	   //senddata(FISHID[0]);
	   redata=redata_tem;
	     if(s_change)//ËÙ¶È±ä»¯
		 {
			 id_change=0;
			id_fan=(FISHID[0]<<5)|(redata_fan&0x0f);
		    if((redata_fan>>4)<<4==0xd0)
		      id_fan=id_fan|0x10;
		    ///////senddata(id_fan);	//Ç°ÈıÎ»ÓÃÀ´±íÊ¾idºÅ£¬µÚ£´Î»Îª£±Ê±ÎªËÙ¶È£¬£°Îª·½Ïò£¬ºóËÄÎ»Îª¾ßÌåµÄËÙ¶È»òÊÇ·½ÏòµÄÖµ
	   
			//senddata(t_dynamic);////////////////////
			s_tem=redata&0x0f;//ËÙ¶Èµµ0-15
			if(s_tem==0)//ËÙ¶È0Ê±£¬Í£Ö¹£¬Ö±
			{
			  for(i=0;i<=2;i++)
				Dynamic_Offset_degree [i]=0;
			  init_dynamic_offset();
	          for(i=0;i<Joint_Num;i++)
	            {
	            Dynamic_Offset_value_last[i]=0;
	            }
	 		}
		    Speed=Speed_tem_z[s_tem];
			for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
			   Amplitude_degree[i]=Amplitude_degree_tem[s_tem][i];
//		    init_dynamic_offset();
		 }//if(s_change)
		 
		 if(d_change)//·½Ïò±ä»¯,ÓĞ¹ı¶É×´Ì¬08.01.14
		 {
			 id_change=0;
			id_fan=(FISHID[0]<<5)|(redata_fan&0x0f);
		    if((redata_fan>>4)<<4==0xd0)
		      id_fan=id_fan|0x10;
		    /////senddata(id_fan);	//Ç°ÈıÎ»ÓÃÀ´±íÊ¾idºÅ£¬µÚ£´Î»Îª£±Ê±ÎªËÙ¶È£¬£°Îª·½Ïò£¬ºóËÄÎ»Îª¾ßÌåµÄËÙ¶È»òÊÇ·½ÏòµÄÖµ
	   
			// senddata(t_dynamic);////////////////////
			 t_dynamic=0;//¹ı¶É×´Ì¬¿ªÊ¼
			 d_tem=redata&0x0f;//×ªÍäµµ0-15
		 	 dd_tem=change_dd(d_tem);
			 flag=change_flag(d_tem);
			// senddata(d_tem);
			// senddata(dd_tem);
			// senddata(flag);
			 for(i=0;i<=2;i++)
			 {
				Dynamic_Offset_degree_char[i]=Dynamic_Offset_degree_origin[dd_tem][i];
			    Dynamic_Offset_degree[i]=char2int(Dynamic_Offset_degree_char[i],flag);
		     }
			 init_dynamic_offset();
			 Speed_dynamic=Speed;
			 d_change_t=1;
			 d_change_t_v=1; 
			// senddata(t_dynamic);////////////////////
		 }//if(d_change)
		 
/*		 if(a_change)//·ù¶È±ä»¯
		 {
			 tem=redata&0x0f;//·ù¶Èµµ0-15
			 for(i=0;i<=2;i++)
			    Amplitude_degree[i]=Amplitude_degree_tem[tem][i];
		 }//if(a_change)
*/		 
		 if(t_change)//µ÷Ö±
		 {
			 id_change=0;
		     senddata(FISHID[0]);
			 tem=redata&0x07;//¹Ø½ÚÊı,0,1,2
			 if(tem>2)
			 {
			 }//if(tem>2)
			 else
			 {
			    if(redata&0x08)//ÓÒµ÷Ö±,1¶È
				{
				   Static_Offset_degree[tem]++;
				}//if(redata&0x08)
				else//×óµ÷Ö±,1¶È
				{
				   Static_Offset_degree[tem]--;
				}//if(redata&0x08) else
			 }//if(tem>2) else
			 init_static_offset();
		 }//if(t_change)
		 
		 if(ts_change)//µ÷Ö±ÊÇ·ñ±£´æ
		 {
			 id_change=0;
		   senddata(FISHID[0]);
		   if(redata&0x04)//±£´æ
		   {
		       i2c_write(ADD_t,degree_I2C,Static_Offset_degree,3);
		   }//if(redata&0x04)
		   else//²»±£´æ
		   {
		       i2c_read(ADD_t,degree_I2C,Static_Offset_degree,3);		   
		   }//if(redatat&0x04) else
		 }//if(ts_change)
		 
		 if(id_change==2)//¸ü¸ÄÓãid
		 {
			 id_change=0;
            senddata(FISHID[0]);
			tem=redata&0x0f;
		    FISHID[0]=tem;
            i2c_write(ADD_i,FISHID_I2C,FISHID,1);
			senddata(FISHID[0]);
		 }//if(id_change)
		 
		 if(f_change)//¸ü¸ÄÆµÂÊ
		 {
			 id_change=0;

		    if(redata_tem==0x41)//ÆµÂÊ1
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x02);
			  senddata(0xbb);
			}
			else if(redata_tem==0x42)//ÆµÂÊ2
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x16);
			  senddata(0xbb);
			}
			else if(redata_tem==0x43)//ÆµÂÊ3
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x2A);
			  senddata(0xbb);
			}
			else if(redata_tem==0x44)//ÆµÂÊ4
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x3B);
			  senddata(0xbb);
			}
			else if(redata_tem==0x45)//ÆµÂÊ5
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x33);
			  senddata(0xbb);
			}
			else if(redata_tem==0x46)//ÆµÂÊ6
			{
			  PORTD=PORTD&0xf4;
			  senddata(0xaa);//0xfc
			  senddata(0x49);
			  senddata(0xff);
			  senddata(0x0c);
			  senddata(0xbb);
			}
			
			//senddata(FISHID[0]);
			//senddata(PORTD&0xf7);//0xf4
						//tem=redata&0x07-4;//0x44-0x47,ÆµÂÊ1-4,tem(0-3)
		    //freqs[0]=tem;
		   // PORTD=freq[freqs[0]];
           // i2c_write(ADD_f,freqs_I2C,freqs,1);
		 }//if(f_change)		
	
	   //ÇåÁãËùÓĞ±êÖ¾Î»,id_changeÔÚÒÔÉÏif(id_change)Ö®ÍâµÄif(*_change)ÖĞÇåÁã
	     isSrlStart=0;
	     addr=0;
		 isInstruction=0;
	     s_change=0;
		 a_change=0;
	     d_change=0;
	     t_change=0;
	     ts_change=0;
	     //id_change=0;
	     f_change=0;
	     e_change=0;
		}//if(e_change)
	   
	   if(m_change)//¸ü¸ÄÄ£Ì¬£¬m_temÄ£Ì¬Âë
	   {
	     m_cishu--;//Èô++µÚÒ»´Î·´Ó¦Âı
	     if(m_cishu==0xff)
	     {
		   mm_cishu--;//Èô++µÚÒ»´Î·´Ó¦Âı
		   if(mm_cishu==0xff)
		   {
			 mmm_cishu++;
			 if(mmm_cishu==m_time)
			 {
		     mmm_cishu=0;
			 //Ö´ĞĞ´úÂë
			 cishu++;
			 if(cishu==3)
			 {
			  cishu=0;
			 }//if(cishu==3)
			 switch(m_tem&0x0f)
			 {
			 case 0x01://Ä£Ì¬1
					   switch(cishu)
					   {
					   case 0x00://0,µÍËÙ1
					             Speed=Speed_tem_z[1];
		                         for(i=0;i<=2;i++)		  
		                            Dynamic_Offset_degree [i]=0;
		                         init_dynamic_offset();
								 
								 break;//0
					   case 0x01://1£¬¸ßËÙ15
								 Speed=Speed_tem_z[15];
								 for(i=0;i<=2;i++)
								    Dynamic_Offset_degree [i]=0;
								 init_dynamic_offset();
								 break;//1  
					   case 0x02://2£¬×ªÍä1
		 	                     for(i=0;i<=2;i++)  
				                   Dynamic_Offset_degree [i]=Dynamic_Offset_degree_origin [1][i];
		                         init_dynamic_offset(); 
					             break;//2
					   }//switch(cishu)
			           break;//caseÄ£Ì¬1
		     case 0x02://Ä£Ì¬2
					   switch(cishu)
					   {
					   case 0x00://0£¬×ó×ª1
		 	                     for(i=0;i<=2;i++)
				                   Dynamic_Offset_degree [i]=Dynamic_Offset_degree_origin [1][i];
		                         init_dynamic_offset(); 
     							 break;//0
					   case 0x01://1£¬ÓÒ×ª12
		 	                     for(i=0;i<=2;i++)
				                   Dynamic_Offset_degree [i]=Dynamic_Offset_degree_origin [12][i];
		                         init_dynamic_offset(); 
								 break;//1
					   case 0x02://2£¬Ç°½ø12
								 Speed=Speed_tem_z[12];
								 for(i=0;i<=2;i++)
								    Dynamic_Offset_degree [i]=0;
								 init_dynamic_offset();					             
								 break;//2
					   }//switch(cishu)			           
			           break;//caseÄ£Ì¬2
			 }//switch(m_tem)
			 //´úÂë½áÊø
			 }//if(mmm_cishu)
		   }//if(mm_cishu)		   
		 }//if(m_cishu)...ÑÓÊ±×÷ÓÃ
       }//if(m_change)
	   
		if(y_change)//Ô­Ê¼×ªÍäÄ£Ê½
		{
			y_cishu--;
			if(y_cishu==0xff)
			{
				yy_cishu--;

				if(yy_cishu==0xff)
				{
					yyy_cishu++;
					yy_cishu=yy_time;

					if(yyy_cishu==y_time)
					{
						yyy_cishu=0;

						//Ö´ĞĞ´úÂë
						if(cishu_y==1)//»Øµ½ÊÕµ½ÃüÁîÇ°µÄËÙ¶È£¬Ö±ÓÎ
						{
							y_change=0;
							y_changing=0;
							Speed=y_speed;
							for(i=0;i<=2;i++)		  
								Dynamic_Offset_degree [i]=0;
							for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
								Amplitude_degree[i]=Amplitude_degree_tem[s_tem][i];
							init_dynamic_offset();
						}//if(cishu_y==1)

						if(cishu_y==0)
						{
							cishu_y++;
							tem_y=y_tem&0x0f;
							Speed=0;
							for(i=0;i<=2;i++)
								Dynamic_Offset_degree [i]=Dynamic_Offset_degree_y [tem_y][i];
							init_dynamic_offset(); 			 
						}//if(cishu_y==0)
						//´úÂë½áÊø

					}//if(yyy_cishu)
				}//if(yy_cishu)		   
			}//if(y_cishu)...ÑÓÊ±×÷ÓÃ
		}//if(y_change)	
	}//if(is_uart==1)

///////////----ÊÖ¶¯Ä£Ê½--END//////////////////////////////////////////	

///////////----×Ô¶¯Ä£Ê½--BEGIN//////////////////////////////////////////	

		else//×Ô¶¯Ä£Ê½,is_uart==0
		{
             a_cishu--;//Èô++µÚÒ»´Î·´Ó¦Âı
	    	    if(a_cishu==0xff)
	            {
		          aa_cishu--;//Èô++µÚÒ»´Î·´Ó¦Âı
		           if(aa_cishu==0xff)
		           {
			           aaa_cishu++;
			           if(aaa_cishu==m_time)
			           {
		                aaa_cishu=0; 
			            //Ö´ĞĞ´úÂë
			            auto_cishu++;
			            if(auto_cishu==7)
			            {
			                 auto_cishu=1;
			             }//if(auto_cishu==6)

					   switch(auto_cishu)
					   {
					   case 0x01://Ö±ÓÎ£¬15
						   Speed=Speed_tem_z[15];
						   for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
							   Amplitude_degree[i]=Amplitude_degree_tem[15][i];
						   for(i=0;i<=2;i++)
							   Dynamic_Offset_degree[i]=0;
						   init_dynamic_offset();
						   break;
					   case 0x02://ÓÒ×ª
						   Speed=Speed_tem_z[15];
						   for(i=0;i<=2;i++)
							{
								Dynamic_Offset_degree_char[i]=Dynamic_Offset_degree_origin[3][i];
								Dynamic_Offset_degree[i]=char2int(Dynamic_Offset_degree_char[i],0);
							}
							init_dynamic_offset();
						   break;
					   case 0x03://Ö±ÓÎ£¬11
						   Speed=Speed_tem_z[11];
						   for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
							   Amplitude_degree[i]=Amplitude_degree_tem[11][i];
						   for(i=0;i<=2;i++)
							   Dynamic_Offset_degree[i]=0;
						   init_dynamic_offset();
						   break;
					   case 0x04://Ö±ÓÎ£¬11
						   Speed=Speed_tem_z[11];
						   for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
							   Amplitude_degree[i]=Amplitude_degree_tem[11][i];
						   for(i=0;i<=2;i++)
							   Dynamic_Offset_degree[i]=0;
						   init_dynamic_offset();
						   break;
					   case 0x05://ÓÒ×ª
						   Speed=Speed_tem_z[11];
                           for(i=0;i<=2;i++)
							{
								Dynamic_Offset_degree_char[i]=Dynamic_Offset_degree_origin[3][i];
								Dynamic_Offset_degree[i]=char2int(Dynamic_Offset_degree_char[i],0);
							}
							init_dynamic_offset();
							break;
						case 0x06://Ö±ÓÎ£¬15
						   Speed=Speed_tem_z[15];
						   for(i=0;i<=2;i++)//¶ÔÓ¦°Ú·ù±ä»¯
							   Amplitude_degree[i]=Amplitude_degree_tem[15][i];
						   for(i=0;i<=2;i++)
							   Dynamic_Offset_degree[i]=0;
						   init_dynamic_offset();
						   break;
					   }//switch(auto_cishu)
			           //´úÂë½áÊø
			         }//if(aaa_cishu)
		         }//if(aa_cishu)		   
		       }//if(a_cishu)...ÑÓÊ±×÷ÓÃ
		    }//×Ô¶¯Ä£Ê½,is_uart==0

///////////----×Ô¶¯Ä£Ê½--END//////////////////////////////////////////	

	}//while(1)
}//main

